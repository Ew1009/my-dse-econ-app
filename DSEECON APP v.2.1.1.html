<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DSE Econ v2.1</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{--pr:#2563eb;--prd:#1d4ed8;--ac:#06b6d4;--ok:#10b981;--wn:#f59e0b;--no:#ef4444;--bg0:#f8fafc;--bg1:#fff;--bg2:#f1f5f9;--tx1:#1e293b;--tx2:#475569;--tx3:#94a3b8;--bd:#e2e8f0;--sh:0 1px 3px rgba(0,0,0,.1);--shl:0 10px 15px -3px rgba(0,0,0,.1)}
.dark{--pr:#3b82f6;--prd:#2563eb;--bg0:#0f172a;--bg1:#1e293b;--bg2:#334155;--tx1:#f1f5f9;--tx2:#cbd5e1;--tx3:#64748b;--bd:#334155}
*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg0);color:var(--tx1);min-height:100vh;overflow:hidden}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg2)}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
.app{display:flex;height:100vh}
.sidebar{width:260px;background:var(--bg1);border-right:1px solid var(--bd);position:fixed;height:100vh;z-index:100;transition:transform .3s;display:flex;flex-direction:column}
.sb-hdr{padding:20px;border-bottom:1px solid var(--bd)}
.logo{display:flex;align-items:center;gap:10px}.logo-ic{width:40px;height:40px;background:linear-gradient(135deg,var(--pr),var(--ac));border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px}
.logo-tx{font-weight:800;font-size:17px}.logo-tx span{color:var(--pr)}.logo-ver{font-size:10px;color:var(--tx3);margin-left:4px;font-weight:500}
.sb-nav{padding:16px 12px;flex:1;overflow-y:auto}
.nav-lbl{font-size:11px;font-weight:700;text-transform:uppercase;color:var(--tx3);padding:8px 12px;margin-top:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:10px;cursor:pointer;transition:all .2s;color:var(--tx2);margin-bottom:4px;font-size:14px;font-weight:500}
.nav-item:hover{background:var(--bg2);color:var(--tx1)}.nav-item.active{background:linear-gradient(135deg,var(--pr),var(--prd));color:#fff}.nav-item i{width:20px;text-align:center}
.sb-ft{padding:16px;border-top:1px solid var(--bd)}
.user-card{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg2);border-radius:12px}
.user-av{width:36px;height:36px;background:linear-gradient(135deg,var(--pr),var(--ac));border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px}
.main{flex:1;margin-left:260px;height:100vh;display:flex;flex-direction:column}
.hdr{background:var(--bg1);border-bottom:1px solid var(--bd);padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.hdr-left{display:flex;align-items:center;gap:16px}
.mob-btn{display:none;width:40px;height:40px;border:none;background:var(--bg2);border-radius:10px;cursor:pointer;color:var(--tx1);font-size:16px;align-items:center;justify-content:center}
.pg-title{font-size:22px;font-weight:700}
.hdr-btn{width:36px;height:36px;border:1px solid var(--bd);background:var(--bg1);border-radius:8px;cursor:pointer;color:var(--tx2);display:flex;align-items:center;justify-content:center;transition:all .2s}.hdr-btn:hover{background:var(--bg2);color:var(--pr)}
.content{flex:1;padding:24px;overflow-y:auto}
.card{background:var(--bg1);border-radius:14px;border:1px solid var(--bd);box-shadow:var(--sh);overflow:hidden}
.card-hdr{padding:18px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.card-t{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}.card-t i{color:var(--pr)}
.card-body{padding:20px}
.btn{padding:11px 20px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:8px;font-family:inherit;transition:all .2s}
.btn-p{background:linear-gradient(135deg,var(--pr),var(--prd));color:#fff}.btn-p:hover{transform:translateY(-1px)}.btn-p:disabled{opacity:.6;cursor:not-allowed;transform:none}
.btn-s{background:var(--bg2);color:var(--tx1);border:1px solid var(--bd)}.btn-s:hover{background:var(--bd)}
.btn-ok{background:var(--ok);color:#fff}.btn-no{background:var(--no);color:#fff}
.btn-sm{padding:8px 14px;font-size:13px}.btn-lg{padding:14px 28px;font-size:15px}
.btn-ghost{background:transparent;color:var(--tx2);padding:8px 12px}.btn-ghost:hover{background:var(--bg2)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600}
.badge-p{background:rgba(37,99,235,.1);color:var(--pr)}.badge-ok{background:rgba(16,185,129,.1);color:var(--ok)}.badge-w{background:rgba(245,158,11,.1);color:var(--wn)}.badge-no{background:rgba(239,68,68,.1);color:var(--no)}
.stat-card{background:var(--bg1);border-radius:14px;padding:20px;border:1px solid var(--bd);position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--pr),var(--ac))}
.stat-ic{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:14px}
.stat-val{font-size:28px;font-weight:800;margin-bottom:4px}.stat-lbl{font-size:13px;color:var(--tx3)}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.progress-bar{height:6px;background:var(--bg2);border-radius:3px;overflow:hidden}.progress-fill{height:100%;background:linear-gradient(90deg,var(--pr),var(--ac));border-radius:3px;transition:width .3s}
.page-sec{display:none}.page-sec.active{display:block;animation:fadeIn .35s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.spinner{width:42px;height:42px;border:3px solid var(--bd);border-top-color:var(--pr);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty-state{text-align:center;padding:50px 20px}.empty-ic{font-size:56px;color:var(--tx3);margin-bottom:16px}.empty-t{font-size:18px;font-weight:700;margin-bottom:8px}.empty-tx{color:var(--tx3);margin-bottom:20px;max-width:360px;margin-left:auto;margin-right:auto;font-size:14px}
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal-box{background:var(--bg1);border-radius:16px;padding:24px;max-width:520px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:var(--shl)}
.toast-ctr{position:fixed;bottom:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--bg1);border:1px solid var(--bd);padding:14px 20px;border-radius:12px;box-shadow:var(--shl);display:flex;align-items:center;gap:12px;animation:slideUp .3s ease;max-width:320px}
.toast.t-ok{border-left:4px solid var(--ok)}.toast.t-err{border-left:4px solid var(--no)}.toast.t-info{border-left:4px solid var(--pr)}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.form-grp{margin-bottom:18px}.form-lbl{display:block;font-weight:600;font-size:13px;margin-bottom:8px}
.form-sel,.form-inp{width:100%;padding:11px 14px;border:1px solid var(--bd);border-radius:8px;font-size:16px;font-family:inherit;background:var(--bg1);color:var(--tx1)}
.form-sel:focus,.form-inp:focus{outline:none;border-color:var(--pr);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.mcq-opts{display:grid;gap:8px}
.mcq-opt{display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border:1px solid var(--bd);border-radius:8px;cursor:pointer;transition:all .2s}
.mcq-opt:hover{border-color:var(--pr);background:rgba(37,99,235,.03)}
.mcq-opt.sel{border-color:var(--pr);background:rgba(37,99,235,.08)}
.mcq-opt.c-ok{border-color:var(--ok);background:rgba(16,185,129,.08)}
.mcq-opt.c-wrong{border-color:var(--no);background:rgba(239,68,68,.08)}
.mcq-opt.dis{pointer-events:none}
.opt-let{min-width:26px;height:26px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0}
.mcq-opt.sel .opt-let{background:var(--pr);color:#fff}
.mcq-opt.c-ok .opt-let{background:var(--ok);color:#fff}
.mcq-opt.c-wrong .opt-let{background:var(--no);color:#fff}
.opt-tx{flex:1;line-height:1.5;font-size:13px}
.ans-sec{margin-top:14px;padding:14px;background:rgba(16,185,129,.08);border-radius:8px;border-left:3px solid var(--ok)}
.quiz-ctr{max-width:800px;margin:0 auto}
.quiz-prog{display:flex;align-items:center;gap:14px;margin-bottom:20px}
.quiz-prog-tx{font-weight:600;color:var(--tx2);white-space:nowrap;font-size:14px}
.quiz-prog-bar{flex:1;height:8px;background:var(--bg2);border-radius:4px;overflow:hidden}
.quiz-prog-fill{height:100%;background:linear-gradient(90deg,var(--pr),var(--ac));transition:width .3s}
.timer-box{text-align:center;padding:20px;background:var(--bg2);border-radius:14px;margin-bottom:20px}
.timer-disp{font-size:42px;font-weight:800;font-variant-numeric:tabular-nums}
.timer-disp.warn{color:var(--wn)}.timer-disp.crit{color:var(--no)}
.quiz-acts{display:flex;justify-content:space-between;margin-top:20px}
.res-sum{text-align:center;padding:36px;background:linear-gradient(135deg,var(--pr),var(--ac));border-radius:16px;color:#fff;margin-bottom:24px}
.res-score{font-size:64px;font-weight:800;margin-bottom:6px}.res-lbl{font-size:16px;opacity:.9}
.res-bd{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:20px}
.bd-item{background:rgba(255,255,255,.2);padding:14px;border-radius:10px}.bd-val{font-size:24px;font-weight:700}.bd-lbl{font-size:12px;opacity:.8}
.topic-sel-grid{display:grid;gap:10px}
.topic-sel-item{display:flex;align-items:center;gap:10px;padding:14px 16px;border:2px solid var(--bd);border-radius:10px;cursor:pointer;transition:all .2s;font-size:13px;font-weight:500}
.topic-sel-item:hover{border-color:var(--pr);background:rgba(37,99,235,.03)}
.topic-sel-item.sel{border-color:var(--pr);background:rgba(37,99,235,.08)}
.topic-sel-item i{color:var(--pr);width:18px}
.type-cards{display:flex;gap:10px;flex-wrap:wrap}
.type-card{flex:1;min-width:100px;padding:14px 10px;border:2px solid var(--bd);border-radius:10px;cursor:pointer;text-align:center;transition:all .2s}
.type-card:hover{border-color:var(--pr)}.type-card.sel{border-color:var(--pr);background:rgba(37,99,235,.1)}
.type-card i{font-size:22px;color:var(--pr);margin-bottom:6px;display:block}
.type-card-t{font-weight:600;font-size:13px;margin-bottom:2px}.type-card-w{font-size:11px;color:var(--tx3)}
.tab-bar{display:flex;border-bottom:2px solid var(--bd);margin-bottom:16px}
.tab-btn{padding:10px 18px;font-size:14px;font-weight:500;color:var(--tx3);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;font-family:inherit}
.tab-btn.active{color:var(--pr);border-bottom-color:var(--pr);font-weight:600}.tab-btn:hover{color:var(--tx1)}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;border:1.5px solid var(--bd);background:var(--bg1);color:var(--tx2);cursor:pointer;transition:all .2s;margin:3px}
.chip.sel{background:rgba(37,99,235,.1);color:var(--pr);border-color:var(--pr)}.chip:hover{border-color:var(--pr)}
.bank-grid{display:grid;grid-template-columns:1fr;gap:12px}
.graph-wrap{position:relative;border:1px solid var(--bd);border-radius:14px;overflow:hidden;background:var(--bg1)}
.graph-wrap canvas{display:block;width:100%;cursor:crosshair;touch-action:none}
.graph-tools{display:flex;gap:4px;flex-wrap:wrap;padding:8px;background:var(--bg2);border-top:1px solid var(--bd)}
.graph-tools button{background:var(--bg1);border:1px solid var(--bd);border-radius:6px;padding:6px 10px;cursor:pointer;color:var(--tx2);font-size:12px;font-family:inherit;font-weight:600;transition:all .15s}
.graph-tools button:hover{background:rgba(37,99,235,.1);color:var(--pr);border-color:var(--pr)}
.rich-bar{display:flex;gap:3px;flex-wrap:wrap;padding:6px;background:var(--bg2);border:1px solid var(--bd);border-bottom:none;border-radius:8px 8px 0 0}
.rich-bar button{background:var(--bg1);border:1px solid var(--bd);border-radius:4px;padding:5px 9px;cursor:pointer;color:var(--tx2);font-size:13px;transition:all .15s}
.rich-bar button:hover{background:rgba(37,99,235,.1);color:var(--pr)}
.rich-ta{border-top:none !important;border-radius:0 0 8px 8px !important}
.split-view{display:flex;gap:16px;flex-direction:column}
.accord-head{cursor:pointer;padding:12px 16px;display:flex;align-items:center;gap:10px;font-weight:600;font-size:14px;border-bottom:1px solid var(--bd);transition:background .15s}
.accord-head:hover{background:var(--bg2)}
.accord-body{padding:12px 16px;display:none;font-size:14px;line-height:1.7}.accord-body.open{display:block}
.md-content h1,.md-content h2,.md-content h3{margin:12px 0 8px;font-weight:700}.md-content p{margin-bottom:8px}.md-content ul,.md-content ol{padding-left:20px;margin-bottom:8px}
.md-content table{width:100%;border-collapse:collapse;margin-bottom:12px}.md-content th,.md-content td{border:1px solid var(--bd);padding:8px 10px;text-align:left;font-size:13px}.md-content th{background:var(--bg2);font-weight:600}
.np{position:fixed;right:20px;bottom:90px;width:340px;max-height:70vh;background:var(--bg1);border-radius:16px;box-shadow:0 10px 50px rgba(0,0,0,.4);overflow:hidden;transform:translateY(20px) scale(.95);opacity:0;pointer-events:none;transition:all .3s ease;z-index:99;border:1px solid var(--bd)}
.np.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
.np-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(135deg,var(--pr),var(--ac));color:#fff}
.np-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
.np-dot{width:100%;aspect-ratio:1;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;border:2px solid transparent}
.np-dot.c-ok{background:rgba(16,185,129,.2);color:var(--ok);border-color:var(--ok)}
.np-dot.c-wrong{background:rgba(239,68,68,.2);color:var(--no);border-color:var(--no)}
.np-dot.c-un{background:rgba(100,116,139,.2);color:var(--tx3);border-color:var(--tx3)}
.loading-ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
.loading-card{background:var(--bg1);padding:36px 50px;border-radius:16px;text-align:center}
.confetti{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:3000;overflow:hidden}
.confetti-piece{position:absolute;width:10px;height:10px;animation:cfall 3s ease-out forwards}
@keyframes cfall{0%{transform:translateY(-100%) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
.voice-pulse{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--no);animation:vpulse 1s infinite}
@keyframes vpulse{0%,100%{opacity:1}50%{opacity:.3}}
.topic-stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
.topic-stat-card{background:var(--bg2);border-radius:12px;padding:16px;border:1px solid var(--bd)}
.ts-hdr{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.ts-ic{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.ts-name{font-weight:600;font-size:13px;flex:1;line-height:1.3}.ts-acc{font-weight:700;font-size:15px;flex-shrink:0}
.nav-fab{position:fixed;right:20px;bottom:24px;z-index:100}
.nav-fab-btn{width:52px;height:52px;border-radius:14px;background:linear-gradient(135deg,var(--pr),var(--ac));color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all .3s;position:relative}
.nav-fab-btn:hover{transform:scale(1.08)}
.fab-badge{position:absolute;top:-6px;right:-6px;background:var(--no);color:#fff;font-size:11px;font-weight:700;min-width:22px;height:22px;border-radius:11px;display:flex;align-items:center;justify-content:center}
@media(max-width:1024px){.grid-4,.grid-3{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}
.sb-ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:99;display:none}.sb-ov.show{display:block}
.main{margin-left:0}.mob-btn{display:flex}.content{padding:16px}
.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.pg-title{font-size:17px}
.res-bd{grid-template-columns:1fr}.type-cards{flex-direction:column}.split-view{flex-direction:column}
}
@media(min-width:769px){.split-view{flex-direction:row}.split-view>*{flex:1;min-width:0}}
@media(min-width:600px){.bank-grid{grid-template-columns:repeat(2,1fr)}}
.an-tabs{display:flex;gap:0;border-bottom:2px solid var(--bd);margin-bottom:20px}
.an-tab{padding:12px 22px;font-size:14px;font-weight:600;color:var(--tx3);background:none;border:none;cursor:pointer;border-bottom:2.5px solid transparent;margin-bottom:-2px;font-family:inherit;transition:all .2s}
.an-tab.active{color:var(--pr);border-bottom-color:var(--pr)}.an-tab:hover{color:var(--tx1)}
.an-pane{display:none}.an-pane.active{display:block;animation:fadeIn .3s ease}
.an-chart-wrap{background:var(--bg1);border:1px solid var(--bd);border-radius:14px;padding:20px;margin-bottom:20px;position:relative;overflow:hidden}
.an-canvas-box{position:relative;width:100%;overflow:hidden}
.an-chart-title{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.an-chart-title i{color:var(--pr)}
.an-kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:22px}
.an-kpi{background:var(--bg1);border:1px solid var(--bd);border-radius:12px;padding:16px;text-align:center;position:relative;overflow:hidden}
.an-kpi::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px}
.an-kpi:nth-child(1)::after{background:var(--pr)}.an-kpi:nth-child(2)::after{background:var(--ac)}.an-kpi:nth-child(3)::after{background:var(--ok)}.an-kpi:nth-child(4)::after{background:var(--wn)}
.an-kpi-val{font-size:26px;font-weight:800;margin-bottom:2px}.an-kpi-lbl{font-size:12px;color:var(--tx3);font-weight:500}
.an-streak-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:20px}
.an-streak-day{aspect-ratio:1;border-radius:4px;background:var(--bg2);position:relative}
.an-streak-day.l1{background:rgba(37,99,235,.15)}.an-streak-day.l2{background:rgba(37,99,235,.3)}.an-streak-day.l3{background:rgba(37,99,235,.5)}.an-streak-day.l4{background:rgba(37,99,235,.75)}
.an-ins-card{background:var(--bg2);border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid var(--pr)}
.an-ins-card h4{font-size:14px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.an-ins-card p{font-size:13px;color:var(--tx2);line-height:1.6}
.an-hist-item{display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid var(--bd)}
.an-hist-item:last-child{border-bottom:none}
.an-hist-badge{min-width:52px;height:52px;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:800;font-size:18px}
.an-hist-badge small{font-size:10px;font-weight:600;opacity:.8}
.an-hist-info{flex:1}.an-hist-title{font-weight:700;font-size:14px;margin-bottom:3px}
.an-hist-meta{font-size:12px;color:var(--tx3);display:flex;flex-wrap:wrap;gap:8px}
@media(max-width:768px){.an-kpi-row{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="app">
  <div class="sb-ov" id="sbOv"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sb-hdr"><div class="logo"><div class="logo-ic"><i class="fas fa-graduation-cap"></i></div><div class="logo-tx">DSE<span>Econ</span><span class="logo-ver">v2.1</span></div></div></div>
    <nav class="sb-nav" id="sbNav"></nav>
    <div class="sb-ft"><div class="user-card"><div class="user-av">S</div><div style="flex:1"><div style="font-weight:600;font-size:13px">Student</div><div style="font-size:11px;color:var(--tx3)">DSE Econ Aspirant</div></div><button class="hdr-btn" id="themeBtn" title="Toggle Theme"><i class="fas fa-moon" id="themeIc"></i></button></div></div>
  </aside>
  <div class="main">
    <header class="hdr"><div class="hdr-left"><button class="mob-btn" id="mobBtn"><i class="fas fa-bars"></i></button><h1 class="pg-title" id="pgTitle">Dashboard</h1></div></header>
    <div class="content" id="content"></div>
  </div>
</div>
<div class="loading-ov" id="loadOv" style="display:none"><div class="loading-card"><div class="spinner"></div><div id="loadTx" style="font-weight:600;margin-bottom:6px">Generating...</div><div id="loadSub" style="font-size:13px;color:var(--tx3)">Please wait</div></div></div>
<div id="modalCtr"></div>
<div class="toast-ctr" id="toastCtr"></div>
<script>
/* === DSE ECON v2.1 === */
(function(){
if(window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches)document.documentElement.classList.add('dark');
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',function(e){e.matches?document.documentElement.classList.add('dark'):document.documentElement.classList.remove('dark');});
})();

/* ---- Topics ---- */
var TOPICS=[
{id:'micro-1',name:'Basic Economic Concepts',icon:'fa-lightbulb',cat:'Micro'},
{id:'micro-2',name:'Firms and Production',icon:'fa-industry',cat:'Micro'},
{id:'micro-3',name:'Markets and Prices',icon:'fa-chart-line',cat:'Micro'},
{id:'micro-4',name:'Competition & Market Structures',icon:'fa-chess',cat:'Micro'},
{id:'micro-5',name:'Efficiency, Equity & Government',icon:'fa-balance-scale',cat:'Micro'},
{id:'macro-1',name:'Measuring Economic Performance',icon:'fa-tachometer-alt',cat:'Macro'},
{id:'macro-2',name:'National Income Determination',icon:'fa-coins',cat:'Macro'},
{id:'macro-3',name:'Money and Banking',icon:'fa-university',cat:'Macro'},
{id:'macro-4',name:'Macro Problems & Policies',icon:'fa-cogs',cat:'Macro'},
{id:'macro-5',name:'International Trade & Finance',icon:'fa-globe-asia',cat:'Macro'}
];
function topicById(id){for(var i=0;i<TOPICS.length;i++){if(TOPICS[i].id===id)return TOPICS[i];}return null;}

/* ---- State ---- */
var S={view:'dashboard',mcq:{ses:null,history:[]},longQ:{ses:null,history:[],bank:[]},aiGen:{history:[]},stats:{sessions:0,time:0,recent:[],topics:{},graphsUsed:0}};

/* ---- Utils ---- */
function genId(){return 'id_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);}
function fmtTime(sec){var m=Math.floor(sec/60);var s2=sec%60;return m+':'+(s2<10?'0':'')+s2;}
function fmtDate(ts){return new Date(ts).toLocaleDateString('en-HK',{day:'numeric',month:'short'});}
function esc(str){var d=document.createElement('div');d.appendChild(document.createTextNode(str));return d.innerHTML;}
function renderMd(t){try{if(typeof marked!=='undefined'&&typeof DOMPurify!=='undefined')return DOMPurify.sanitize(marked.parse(t||''));}catch(e){/* empty */}return esc(t||'');}
function shuffle(a){a=a.slice();for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=a[i];a[i]=a[j];a[j]=tmp;}return a;}

/* ---- Toast ---- */
function toast(msg,type){
  type=type||'info';var ctr=document.getElementById('toastCtr');
  var cls=type==='ok'?'t-ok':type==='err'?'t-err':'t-info';
  var col=type==='ok'?'var(--ok)':type==='err'?'var(--no)':'var(--pr)';
  var icons={ok:'fa-check-circle',err:'fa-times-circle',info:'fa-info-circle'};
  var el=document.createElement('div');el.className='toast '+cls;
  el.innerHTML='<i class="fas '+(icons[type]||icons.info)+'" style="font-size:18px;color:'+col+'"></i><div style="flex:1;font-weight:600;font-size:13px">'+msg+'</div>';
  ctr.appendChild(el);setTimeout(function(){el.style.opacity='0';el.style.transition='opacity .3s';setTimeout(function(){el.remove();},300);},3000);
}

/* ---- Modal ---- */
var Modal={
  show:function(html){document.getElementById('modalCtr').innerHTML='<div class="modal-ov" onclick="if(event.target===this)Modal.hide()"><div class="modal-box">'+html+'</div></div>';},
  confirm:function(msg,onYes){
    var h='<p style="font-size:15px;margin-bottom:18px">'+msg+'</p><div style="display:flex;gap:10px;justify-content:flex-end"><button class="btn btn-s" onclick="Modal.hide()">Cancel</button><button class="btn btn-p" id="mcBtn">Confirm</button></div>';
    this.show(h);document.getElementById('mcBtn').onclick=function(){Modal.hide();if(onYes)onYes();};
  },
  hide:function(){document.getElementById('modalCtr').innerHTML='';}
};

/* ---- Nav ---- */
var NAV=[
{id:'dashboard',icon:'fa-home',label:'Dashboard'},
{id:'practice',icon:'fa-graduation-cap',label:'Practice'},
{id:'ai-gen',icon:'fa-robot',label:'AI Generation'},
{id:'analytics',icon:'fa-chart-pie',label:'Analytics'}
];
function recordActivity(type,score,dur,topicId){
  S.stats.sessions++;S.stats.time+=dur;
  S.stats.recent.push({type:type,score:score,duration:dur,topic:topicId,ts:Date.now()});
  if(S.stats.recent.length>50)S.stats.recent.shift();
}
function initNav(){
  var sb=document.getElementById('sbNav');var h='<div class="nav-lbl">Menu</div>';
  NAV.forEach(function(n){h+='<div class="nav-item'+(S.view===n.id?' active':'')+'" data-nav="'+n.id+'"><i class="fas '+n.icon+'"></i>'+n.label+'</div>';});
  sb.innerHTML=h;
  sb.querySelectorAll('.nav-item').forEach(function(el){el.onclick=function(){switchView(el.dataset.nav);};});
  document.getElementById('mobBtn').onclick=function(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sbOv').classList.toggle('show');};
  document.getElementById('sbOv').onclick=function(){document.getElementById('sidebar').classList.remove('open');this.classList.remove('show');};
  document.getElementById('themeBtn').onclick=function(){
    document.documentElement.classList.toggle('dark');
    document.getElementById('themeIc').className=document.documentElement.classList.contains('dark')?'fas fa-sun':'fas fa-moon';
  };
}
function switchView(id){
  S.view=id;
  var navItem=NAV.find(function(n){return n.id===id;});
  document.getElementById('pgTitle').textContent=navItem?navItem.label:'App';
  document.getElementById('sbNav').querySelectorAll('.nav-item').forEach(function(el){el.classList.toggle('active',el.dataset.nav===id);});
  document.getElementById('sidebar').classList.remove('open');document.getElementById('sbOv').classList.remove('show');
  var c=document.getElementById('content');c.innerHTML='';
  if(Sections[id])Sections[id](c);
  else c.innerHTML='<div class="empty-state"><div class="empty-ic"><i class="fas fa-wrench"></i></div><div class="empty-t">Coming Soon</div></div>';
}
var Sections={};

/* ---- Dashboard ---- */
function statCard(val,lbl,icon,bg,col){return '<div class="stat-card"><div class="stat-ic" style="background:'+bg+';color:'+col+'"><i class="fas '+icon+'"></i></div><div class="stat-val">'+val+'</div><div class="stat-lbl">'+lbl+'</div></div>';}
Sections.dashboard=function(c){
  var st=S.stats;var tq=0,tc=0;
  Object.keys(st.topics).forEach(function(k){tq+=st.topics[k].attempted;tc+=st.topics[k].correct;});
  var acc=tq>0?Math.round(tc/tq*100):0;
  var h='<div class="page-sec active">';
  h+='<div style="margin-bottom:24px"><h2 style="font-size:1.5rem;font-weight:800">Welcome back! ðŸ“š</h2><p style="color:var(--tx2);font-size:14px">HKDSE Economics Study Companion</p></div>';
  h+='<div class="grid-4" style="margin-bottom:24px">';
  h+=statCard(st.sessions,'Sessions','fa-book-open','rgba(37,99,235,.1)','var(--pr)');
  h+=statCard(tq,'Questions','fa-list-ol','rgba(6,182,212,.1)','var(--ac)');
  h+=statCard(acc+'%','Accuracy','fa-bullseye','rgba(16,185,129,.1)','var(--ok)');
  h+=statCard(fmtTime(st.time),'Study Time','fa-clock','rgba(245,158,11,.1)','var(--wn)');
  h+='</div>';
  h+='<h3 style="font-weight:700;margin-bottom:12px">Quick Start</h3><div class="grid-3" style="margin-bottom:24px">';
  [{icon:'fa-graduation-cap',co:'var(--pr)',l:'Practice',d:'MCQ & Long Questions',v:'practice'},{icon:'fa-robot',co:'var(--ok)',l:'AI Generation',d:'Custom questions',v:'ai-gen'},{icon:'fa-chart-pie',co:'var(--ac)',l:'Analytics',d:'Track your progress',v:'analytics'}].forEach(function(a){
    h+='<div class="card" style="cursor:pointer;transition:all .2s" onclick="switchView(\''+a.v+'\')" onmouseover="this.style.transform=\'translateY(-2px)\'" onmouseout="this.style.transform=\'none\'"><div class="card-body" style="display:flex;align-items:center;gap:14px"><div style="width:44px;height:44px;border-radius:10px;background:'+a.co+'18;display:flex;align-items:center;justify-content:center"><i class="fas '+a.icon+'" style="color:'+a.co+';font-size:18px"></i></div><div><div style="font-weight:700;font-size:14px">'+a.l+'</div><div style="font-size:12px;color:var(--tx3)">'+a.d+'</div></div></div></div>';
  });
  h+='</div>';
  var rec=st.recent.slice().reverse().slice(0,5);
  h+='<h3 style="font-weight:700;margin-bottom:12px">Recent Activity</h3>';
  if(!rec.length)h+='<div class="empty-state" style="padding:30px"><div class="empty-ic"><i class="fas fa-clock"></i></div><div class="empty-t">No activity yet</div><div class="empty-tx">Start a practice session!</div></div>';
  else rec.forEach(function(r){var co=r.score>=70?'var(--ok)':r.score>=50?'var(--wn)':'var(--no)';h+='<div class="card" style="margin-bottom:8px"><div class="card-body" style="padding:14px 18px;display:flex;align-items:center;gap:14px"><div style="width:38px;height:38px;border-radius:50%;background:'+co+'18;display:flex;align-items:center;justify-content:center"><i class="fas '+(r.type==='mcq'?'fa-list-ol':'fa-pen-fancy')+'" style="color:'+co+';font-size:14px"></i></div><div style="flex:1"><div style="font-weight:600;font-size:14px">'+r.type.toUpperCase()+' Session</div><div style="font-size:12px;color:var(--tx3)">'+fmtDate(r.ts)+' &bull; '+fmtTime(r.duration)+'</div></div><span class="badge" style="background:'+co+'18;color:'+co+'">'+r.score+'%</span></div></div>';});
  h+='</div>';c.innerHTML=h;
};

/* ---- MCQ Bank ---- */
var MCQ_BANK=[
{id:'m1',topic:'micro-1',q:'Which best illustrates opportunity cost?',opts:['The monetary price paid for a good','The value of the next best alternative foregone','The total cost of production','The profit earned from selling a good'],ans:1,exp:'Opportunity cost is the value of the next best alternative given up.'},
{id:'m2',topic:'micro-1',q:'The Production Possibilities Curve (PPC) shows:',opts:['Maximum profit combinations','Maximum output combinations with given resources','All possible prices','Consumer preferences'],ans:1,exp:'The PPC illustrates maximum output combinations producible with given resources.'},
{id:'m3',topic:'micro-1',q:'Which statement about economic goods is correct?',opts:['Always tangible','Free of charge','Scarce relative to wants','No opportunity cost'],ans:2,exp:'Economic goods are scarce relative to wants.'},
{id:'m4',topic:'micro-3',q:'Price rises from $10 to $12, Qd falls 100 to 80. PED is:',opts:['-0.5','-1.0','-1.5','-2.0'],ans:1,exp:'PED = (-20%/20%) = -1.0'},
{id:'m5',topic:'micro-3',q:'XED between A and B is +2.5. The goods are:',opts:['Complements','Substitutes','Unrelated','Inferior'],ans:1,exp:'Positive XED = substitute goods.'},
{id:'m6',topic:'micro-3',q:'Price ceiling below equilibrium results in:',opts:['Surplus','Shortage','No change','Higher price'],ans:1,exp:'Binding price ceiling creates shortage (Qd > Qs).'},
{id:'m7',topic:'micro-3',q:'Law of demand states, ceteris paribus:',opts:['Income up then demand up','Price down then Qd up','Supply up then price down','Tech up then cost down'],ans:1,exp:'Inverse relationship between price and quantity demanded.'},
{id:'m8',topic:'micro-3',q:'Leftward shift of supply could be caused by:',opts:['Better technology','Lower input costs','Higher input costs','More firms'],ans:2,exp:'Higher input costs reduce supply.'},
{id:'m9',topic:'micro-4',q:'In perfect competition, firms are price takers because:',opts:['Gov sets prices','Each firm output is negligible','Barriers to entry','Differentiated products'],ans:1,exp:'Each firm is too small to influence market price.'},
{id:'m10',topic:'micro-4',q:'Monopolist earns LR profits because:',opts:['Elastic demand','No barriers','Significant barriers to entry','Min AC production'],ans:2,exp:'Barriers prevent entry, sustaining profits.'},
{id:'m11',topic:'micro-2',q:'Law of diminishing marginal returns states:',opts:['Total output falls','More variable input then smaller increments','AC always rises','FC increase'],ans:1,exp:'Marginal product of variable input eventually decreases.'},
{id:'m12',topic:'micro-2',q:'If MC < ATC, then ATC is:',opts:['Rising','Falling','Constant','At minimum'],ans:1,exp:'MC < ATC pulls the average down.'},
{id:'m13',topic:'micro-5',q:'Negative externality in production means:',opts:['Social cost > Private cost','Private cost > Social cost','Social benefit > Private benefit','No market failure'],ans:0,exp:'Negative externalities: social cost exceeds private cost.'},
{id:'m14',topic:'micro-5',q:'Example of a public good:',opts:['Private pool','Bread','National defence','Cinema ticket'],ans:2,exp:'National defence: non-excludable and non-rivalrous.'},
{id:'m15',topic:'micro-3',q:'YED for an inferior good is:',opts:['Positive','Zero','Negative','Greater than 1'],ans:2,exp:'Inferior goods: negative YED.'},
{id:'m16',topic:'micro-5',q:'HK plastic bag levy is:',opts:['Subsidy','Pigouvian tax','Price ceiling','Public good'],ans:1,exp:'Corrective tax to reduce negative externalities.'},
{id:'m17',topic:'macro-1',q:'GDP at market prices includes:',opts:['Only final goods and services','Intermediate goods','Second-hand goods','Transfer payments'],ans:0,exp:'GDP counts only final goods to avoid double counting.'},
{id:'m18',topic:'macro-1',q:'NOT in HK GDP calculation:',opts:['Gov hospital spending','Resident groceries','Foreign worker remittances','Factory investment'],ans:2,exp:'Remittances are transfer payments.'},
{id:'m19',topic:'macro-2',q:'The multiplier effect refers to:',opts:['Doubling money supply','Amplified spending impact on national income','Interest rate effects','Tax multiplication'],ans:1,exp:'Initial injection triggers successive spending rounds.'},
{id:'m20',topic:'macro-2',q:'If MPC = 0.8, multiplier is:',opts:['2','4','5','8'],ans:2,exp:'1/(1-0.8) = 5.'},
{id:'m21',topic:'macro-3',q:'A function of money:',opts:['Store of debt','Medium of exchange','Source of inflation','Measure of profit'],ans:1,exp:'Money: medium of exchange, store of value, unit of account.'},
{id:'m22',topic:'macro-3',q:'When a bank makes a loan, it:',opts:['Destroys money','Creates money via credit creation','Reduces money supply','No effect'],ans:1,exp:'Banks create deposits when making loans.'},
{id:'m23',topic:'macro-3',q:'Reserve ratio 10%, credit multiplier is:',opts:['5','10','20','100'],ans:1,exp:'1/0.1 = 10.'},
{id:'m24',topic:'macro-4',q:'Demand-pull inflation caused by:',opts:['Rising costs','Excessive AD','Supply disruptions','Falling money supply'],ans:1,exp:'AD exceeds AS at full employment.'},
{id:'m25',topic:'macro-4',q:'Fiscal policy to reduce inflation:',opts:['More gov spending','Tax cuts','Less gov spending','More money supply'],ans:2,exp:'Contractionary fiscal policy reduces AD.'},
{id:'m26',topic:'macro-4',q:'Structural unemployment caused by:',opts:['Seasonal changes','Skills-job mismatch','Low AD','Job searching'],ans:1,exp:'Mismatch between skills and job requirements.'},
{id:'m27',topic:'macro-5',q:'Comparative advantage: trade benefits when:',opts:['Country produces everything cheaply','Specialise in lower opportunity cost','Balanced trade','Fixed exchange rates'],ans:1,exp:'Specialise where opportunity cost is lowest.'},
{id:'m28',topic:'macro-5',q:'HK linked rate pegs HKD to:',opts:['Yuan','Yen','US Dollar','Pound'],ans:2,exp:'Since 1983, pegged to USD ~7.8:1.'},
{id:'m29',topic:'macro-5',q:'Current account deficit means:',opts:['Exports > Imports','Imports > Exports','Capital inflow > outflow','Gov spending > Revenue'],ans:1,exp:'Imports exceed exports.'},
{id:'m30',topic:'macro-4',q:'Increasing money supply is:',opts:['Contractionary fiscal','Expansionary monetary','Supply-side','Trade policy'],ans:1,exp:'Expansionary monetary policy stimulates activity.'},
{id:'m31',topic:'micro-1',q:'Basic economic problem arises because:',opts:['Gov intervention','Scarce resources, unlimited wants','Fast tech change','Irrationality'],ans:1,exp:'Scarcity: limited resources vs unlimited wants.'},
{id:'m32',topic:'micro-2',q:'Economies of scale refer to:',opts:['Rising costs','Falling average costs with output','Constant returns','Diminishing returns'],ans:1,exp:'Larger scale leads to lower LRAC.'},
{id:'m33',topic:'micro-3',q:'Inelastic demand + price increase:',opts:['TR increases','TR decreases','TR unchanged','Profits eliminated'],ans:0,exp:'Percentage change in Qd < percentage change in P so TR rises.'},
{id:'m34',topic:'micro-4',q:'Most firms in which structure?',opts:['Monopoly','Oligopoly','Monopolistic competition','Perfect competition'],ans:3,exp:'Perfect competition: very large number of firms.'},
{id:'m35',topic:'macro-1',q:'Real GDP vs nominal: real GDP is:',opts:['Includes depreciation','Adjusted for price changes','Excludes exports','Always higher'],ans:1,exp:'Real GDP removes price change effects.'},
{id:'m36',topic:'macro-2',q:'Increase in G shifts:',opts:['AS left','AD right','AS right','AD left'],ans:1,exp:'G is AD component; increase shifts AD right.'},
{id:'m37',topic:'macro-3',q:'HKMA maintains linked rate using:',opts:['Tax changes','Open market operations','Min wage','Import quotas'],ans:1,exp:'HKMA buys/sells USD.'},
{id:'m38',topic:'macro-5',q:'Tariff on imports will:',opts:['Lower prices','Increase imports','Raise import prices','Increase consumer surplus'],ans:2,exp:'Tariffs make imports more expensive.'},
{id:'m39',topic:'micro-5',q:'Gov education provision justified by:',opts:['Negative externalities','Positive externalities','No externalities','Only private benefits'],ans:1,exp:'Education: positive externalities for society.'},
{id:'m40',topic:'macro-4',q:'Stagflation refers to:',opts:['High growth, low inflation','High inflation + high unemployment','Low inflation, low unemployment','Rapid growth'],ans:1,exp:'Stagnant growth + rising prices.'}
];

/* ---- MCQ Timer ---- */
var mcqTimer=null;
function startMcqTimer(){
  if(mcqTimer)clearInterval(mcqTimer);
  mcqTimer=setInterval(function(){
    var ses=S.mcq.ses;if(!ses){clearInterval(mcqTimer);return;}
    ses.elapsed++;
    if(ses.timeLimit>0&&ses.elapsed>=ses.timeLimit){clearInterval(mcqTimer);finishMcq();}
    var el=document.getElementById('mcqTimerDisp');
    if(el){var rem=ses.timeLimit>0?ses.timeLimit-ses.elapsed:ses.elapsed;
      el.textContent=fmtTime(Math.max(0,rem));
      if(ses.timeLimit>0){el.className='timer-disp'+(rem<30?' crit':rem<60?' warn':'');}
    }
  },1000);
}

/* ---- Unified Practice Section ---- */
var practiceTab=S._practiceTab||'mcq';
Sections.practice=function(c){
  /* If active MCQ session, show it directly */
  if(S.mcq.ses){renderMcqSession(c);return;}
  /* If active Long Q session, show it directly */
  if(S.longQ.ses){renderLongQSession(c);return;}
  var h='<div class="page-sec active">';
  h+='<div style="text-align:center;margin-bottom:24px"><h2 style="font-size:1.5rem;font-weight:800"><i class="fas fa-graduation-cap" style="color:var(--pr);margin-right:8px"></i>Practice</h2><p style="color:var(--tx2);margin-top:4px">Sharpen your skills for the HKDSE</p></div>';

  /* Top-level tabs: MCQ | Long Questions */
  h+='<div class="tab-bar" id="pracTabs" style="margin-bottom:20px">';
  h+='<button class="tab-btn '+(practiceTab==='mcq'?'active':'')+'" data-ptab="mcq"><i class="fas fa-list-ol" style="margin-right:6px"></i>MCQ (Paper 1)</button>';
  h+='<button class="tab-btn '+(practiceTab==='longq'?'active':'')+'" data-ptab="longq"><i class="fas fa-pen-fancy" style="margin-right:6px"></i>Long Questions (Paper 2)</button>';
  h+='</div>';

  /* MCQ pane */
  h+='<div id="pracMcqPane" style="display:'+(practiceTab==='mcq'?'block':'none')+'">';
  h+=renderMcqLanding();
  h+='</div>';

  /* Long Q pane */
  h+='<div id="pracLqPane" style="display:'+(practiceTab==='longq'?'block':'none')+'">';
  h+=renderLqLanding();
  h+='</div>';

  h+='</div>';
  c.innerHTML=h;

  /* Tab switching */
  c.querySelectorAll('#pracTabs .tab-btn').forEach(function(btn){
    btn.onclick=function(){
      c.querySelectorAll('#pracTabs .tab-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      practiceTab=btn.dataset.ptab;
      S._practiceTab=practiceTab;
      document.getElementById('pracMcqPane').style.display=practiceTab==='mcq'?'block':'none';
      document.getElementById('pracLqPane').style.display=practiceTab==='longq'?'block':'none';
      if(practiceTab==='mcq')wireMcqLanding(c);
      if(practiceTab==='longq')wireLqLanding(c);
    };
  });

  /* Wire MCQ pane */
  if(practiceTab==='mcq')wireMcqLanding(c);

  /* Wire Long Q pane if active */
  if(practiceTab==='longq')wireLqLanding(c);
};

/* ---- MCQ: count questions per topic ---- */
function mcqCountByTopic(tid){
  if(!tid)return MCQ_BANK.length;
  var c2=0;for(var i=0;i<MCQ_BANK.length;i++){if(MCQ_BANK[i].topic===tid)c2++;}return c2;
}
var _mcqMode='topic';

/* MCQ landing HTML â€” matches reference screenshots */
function renderMcqLanding(){
  var totalQ=MCQ_BANK.length;
  var h='';

  /* Sub-tabs: Practice | Past Sessions */
  h+='<div class="tab-bar" id="mcqSubTabs" style="margin-bottom:16px">';
  h+='<button class="tab-btn active" data-msub="setup">Practice</button>';
  h+='<button class="tab-btn" data-msub="history">Past Sessions</button>';
  h+='</div>';

  /* Practice setup pane */
  h+='<div id="mcqSetupPane">';

  /* Mode selector card */
  h+='<div class="card" style="margin-bottom:20px"><div class="card-body">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px"><i class="fas fa-exchange-alt" style="color:var(--pr)"></i><span style="font-weight:700;font-size:16px">Practice Mode</span></div>';
  h+='<p style="color:var(--tx2);font-size:13px;margin-bottom:16px">Choose your practice mode with <strong>'+totalQ+' authentic HKDSE past paper questions</strong>.</p>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  [{id:'topic',ic:'fa-bullseye',t:'Topic Practice',d:'Intensive training'},
   {id:'exam',ic:'fa-file-alt',t:'Exam Mode',d:'40 Qs \u00b7 1 Hour'},
   {id:'quiz',ic:'fa-clock',t:'Quiz Mode',d:'Timed challenge'}].forEach(function(m){
    h+='<div class="type-card'+(m.id===_mcqMode?' sel':'')+'" data-mcqmode="'+m.id+'" style="padding:18px 10px"><i class="fas '+m.ic+'"></i><div class="type-card-t">'+m.t+'</div><div class="type-card-w">'+m.d+'</div></div>';
  });
  h+='</div></div></div>';

  /* ---- Topic Practice panel ---- */
  h+='<div id="mcqPanelTopic" class="card" style="margin-bottom:20px;display:'+(_mcqMode==='topic'?'block':'none')+'"><div class="card-body">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><i class="fas fa-bullseye" style="color:var(--pr)"></i><span style="font-weight:700;font-size:16px">Topic Practice</span></div>';
  h+='<p style="color:var(--tx2);font-size:13px;margin-bottom:16px">Focus on specific topics for intensive revision. No time pressure.</p>';
  h+='<div style="font-weight:700;font-size:13px;margin-bottom:10px">Select Topic</div>';
  h+='<div class="topic-sel-grid" id="topicTopicList">';
  /* All Topics option */
  h+='<div class="topic-sel-item sel" data-tid="all"><i class="fas fa-th-large"></i><span style="flex:1">All Topics</span><span style="color:var(--tx3);font-size:12px">('+totalQ+')</span></div>';
  TOPICS.forEach(function(t){
    var cnt=mcqCountByTopic(t.id);
    h+='<div class="topic-sel-item" data-tid="'+t.id+'"><i class="fas '+t.icon+'"></i><span style="flex:1">'+t.name+'</span><span style="color:var(--tx3);font-size:12px">('+cnt+')</span></div>';
  });
  h+='</div>';
  h+='<div style="font-weight:700;font-size:13px;margin:18px 0 10px">Number of Questions</div>';
  h+='<select class="form-sel" id="topicQCount" style="width:100%;font-size:16px"><option value="10">10 Questions</option><option value="20">20 Questions</option><option value="30">30 Questions</option></select>';
  h+='<label style="display:flex;align-items:center;gap:8px;margin-top:14px;font-size:13px;cursor:pointer"><input type="checkbox" id="topicTimeCheck"><span>Enable Time Limit</span></label>';
  h+='<button class="btn btn-p btn-lg" style="width:100%;margin-top:18px;justify-content:center" id="topicStartBtn"><i class="fas fa-play"></i>Start Topic Practice</button>';
  h+='</div></div>';

  /* ---- Exam Mode panel ---- */
  h+='<div id="mcqPanelExam" class="card" style="margin-bottom:20px;display:'+(_mcqMode==='exam'?'block':'none')+'"><div class="card-body" style="text-align:center">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;justify-content:center"><i class="fas fa-file-alt" style="color:var(--pr)"></i><span style="font-weight:700;font-size:16px">Exam Mode</span></div>';
  h+='<div style="font-size:48px;margin-bottom:12px"><i class="fas fa-file-signature" style="color:var(--wn)"></i></div>';
  h+='<div style="font-weight:700;font-size:17px;margin-bottom:6px">HKDSE Exam Simulation</div>';
  h+='<p style="color:var(--tx2);font-size:13px;margin-bottom:20px">40 randomly selected questions from all topics.<br>Strict 1-hour time limit. No going back!</p>';
  h+='<div style="display:flex;gap:12px;justify-content:center;margin-bottom:18px">';
  [{v:'40',l:'Questions'},{v:'60',l:'Minutes'},{v:''+TOPICS.length,l:'Topics'}].forEach(function(s4){
    h+='<div style="border:2px solid var(--ac);border-radius:12px;padding:14px 20px;min-width:80px"><div style="font-size:22px;font-weight:800;color:var(--ac)">'+s4.v+'</div><div style="font-size:11px;color:var(--tx3)">'+s4.l+'</div></div>';
  });
  h+='</div>';
  h+='<div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:10px;padding:12px 16px;color:var(--wn);font-size:12px;font-weight:600;margin-bottom:18px"><i class="fas fa-exclamation-triangle" style="margin-right:6px"></i>Warning: Once started, you cannot pause or restart. Make sure you have 1 hour available.</div>';
  h+='<button class="btn btn-p btn-lg" style="justify-content:center" id="examStartBtn"><i class="fas fa-play"></i>Begin Exam</button>';
  h+='</div></div>';

  /* ---- Quiz Mode panel ---- */
  h+='<div id="mcqPanelQuiz" class="card" style="margin-bottom:20px;display:'+(_mcqMode==='quiz'?'block':'none')+'"><div class="card-body">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><i class="fas fa-clock" style="color:var(--pr)"></i><span style="font-weight:700;font-size:16px">Quiz Mode</span></div>';
  h+='<p style="color:var(--tx2);font-size:13px;margin-bottom:16px">Timed challenge! Question count is based on time selected.</p>';
  h+='<div style="font-weight:700;font-size:13px;margin-bottom:10px">Select Topics (multiple allowed)</div>';
  h+='<div class="topic-sel-grid" id="quizTopicList">';
  TOPICS.forEach(function(t){
    var cnt=mcqCountByTopic(t.id);
    h+='<div class="topic-sel-item" data-tid="'+t.id+'"><i class="fas '+t.icon+'"></i><span style="flex:1">'+t.name+'</span><span style="color:var(--tx3);font-size:12px">('+cnt+')</span></div>';
  });
  h+='</div>';
  h+='<div style="font-weight:700;font-size:13px;margin:18px 0 10px">Time Limit</div>';
  h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
  [{t:'10 min',d:'10 Questions',v:10},{t:'15 min',d:'15 Questions',v:15},{t:'30 min',d:'25 Questions',v:30}].forEach(function(tl,i){
    h+='<div class="type-card'+(i===0?' sel':'')+'" data-time="'+tl.v+'" data-qcount="'+(tl.v===10?10:tl.v===15?15:25)+'"><div class="type-card-t">'+tl.t+'</div><div class="type-card-w">'+tl.d+'</div></div>';
  });
  h+='</div>';
  h+='<button class="btn btn-p btn-lg" style="width:100%;margin-top:18px;justify-content:center" id="quizStartBtn"><i class="fas fa-play"></i>Start Quiz</button>';
  h+='</div></div>';

  h+='</div>'; /* end mcqSetupPane */

  /* Past Sessions pane */
  h+='<div id="mcqHistoryPane" style="display:none"><div id="mcqHistoryList"></div></div>';

  return h;
}

/* Wire MCQ landing interactions */
function wireMcqLanding(c){
  /* Sub-tab switching */
  var subBtns=c.querySelectorAll('#mcqSubTabs .tab-btn');
  if(!subBtns.length)return;
  subBtns.forEach(function(btn){
    btn.onclick=function(){
      c.querySelectorAll('#mcqSubTabs .tab-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      var st=btn.dataset.msub;
      document.getElementById('mcqSetupPane').style.display=st==='setup'?'block':'none';
      document.getElementById('mcqHistoryPane').style.display=st==='history'?'block':'none';
      if(st==='history')renderMcqHistory();
    };
  });

  /* Mode selector cards */
  c.querySelectorAll('[data-mcqmode]').forEach(function(el){
    el.onclick=function(){
      c.querySelectorAll('[data-mcqmode]').forEach(function(e){e.classList.remove('sel');});
      el.classList.add('sel');
      _mcqMode=el.dataset.mcqmode;
      document.getElementById('mcqPanelTopic').style.display=_mcqMode==='topic'?'block':'none';
      document.getElementById('mcqPanelExam').style.display=_mcqMode==='exam'?'block':'none';
      document.getElementById('mcqPanelQuiz').style.display=_mcqMode==='quiz'?'block':'none';
    };
  });

  /* ---- Topic Practice wiring ---- */
  var topicItems=c.querySelectorAll('#topicTopicList .topic-sel-item');
  topicItems.forEach(function(el){
    el.onclick=function(){
      /* Single-select: clicking one deselects others */
      topicItems.forEach(function(e){e.classList.remove('sel');});
      el.classList.add('sel');
    };
  });
  var topicStartBtn=document.getElementById('topicStartBtn');
  if(topicStartBtn)topicStartBtn.onclick=function(){
    var selTid=null;
    c.querySelectorAll('#topicTopicList .topic-sel-item.sel').forEach(function(e){selTid=e.dataset.tid;});
    if(!selTid){toast('Select a topic','err');return;}
    var topics=selTid==='all'?TOPICS.map(function(t){return t.id;}):[selTid];
    var count=parseInt(document.getElementById('topicQCount').value,10);
    var hasTime=document.getElementById('topicTimeCheck').checked;
    startMcqSession(hasTime?'quiz':'topic',topics,count);
  };

  /* ---- Exam Mode wiring ---- */
  var examStartBtn=document.getElementById('examStartBtn');
  if(examStartBtn)examStartBtn.onclick=function(){
    startMcqSession('exam',TOPICS.map(function(t){return t.id;}),40);
  };

  /* ---- Quiz Mode wiring ---- */
  var quizTopicItems=c.querySelectorAll('#quizTopicList .topic-sel-item');
  quizTopicItems.forEach(function(el){
    el.onclick=function(){el.classList.toggle('sel');};
  });
  c.querySelectorAll('#mcqPanelQuiz .type-card').forEach(function(el){
    el.onclick=function(){
      c.querySelectorAll('#mcqPanelQuiz .type-card').forEach(function(e){e.classList.remove('sel');});
      el.classList.add('sel');
    };
  });
  var quizStartBtn=document.getElementById('quizStartBtn');
  if(quizStartBtn)quizStartBtn.onclick=function(){
    var topics=[];
    c.querySelectorAll('#quizTopicList .topic-sel-item.sel').forEach(function(e){topics.push(e.dataset.tid);});
    if(!topics.length){toast('Select at least one topic','err');return;}
    var timeEl=c.querySelector('#mcqPanelQuiz .type-card.sel');
    var timeMins=timeEl?parseInt(timeEl.dataset.time,10):10;
    var qcount=timeEl?parseInt(timeEl.dataset.qcount,10):10;
    startMcqSession('quiz',topics,qcount,timeMins*60);
  };

  /* Past Sessions renderer */
  function renderMcqHistory(){
    var list=document.getElementById('mcqHistoryList');if(!list)return;
    if(!S.mcq.history.length){list.innerHTML='<div class="empty-state" style="padding:30px"><div class="empty-ic" style="font-size:32px"><i class="fas fa-inbox"></i></div><div class="empty-t">No sessions yet</div><div class="empty-tx">Complete a practice session to see your history</div></div>';return;}
    var hh='';
    S.mcq.history.slice().reverse().forEach(function(s3){
      var co=s3.score>=70?'var(--ok)':s3.score>=50?'var(--wn)':'var(--no)';
      hh+='<div class="card" style="margin-bottom:10px"><div class="card-body" style="padding:14px 18px;display:flex;align-items:center;gap:14px">';
      hh+='<div style="width:38px;height:38px;border-radius:50%;background:'+co+'18;display:flex;align-items:center;justify-content:center"><i class="fas fa-list-ol" style="color:'+co+';font-size:14px"></i></div>';
      hh+='<div style="flex:1"><div style="font-weight:600;font-size:14px">'+s3.mode.charAt(0).toUpperCase()+s3.mode.slice(1)+' Mode &bull; '+s3.correct+'/'+s3.total+'</div><div style="font-size:12px;color:var(--tx3)">'+fmtDate(s3.ts)+' &bull; '+fmtTime(s3.duration)+'</div></div>';
      hh+='<span class="badge" style="background:'+co+'18;color:'+co+'">'+s3.score+'%</span>';
      hh+='</div></div>';
    });
    list.innerHTML=hh;
  }
}

function startMcqSession(mode,topics,count,customTimeLimit){
  var pool=MCQ_BANK.filter(function(q){return topics.indexOf(q.topic)>=0;});
  pool=shuffle(pool).slice(0,Math.min(count,pool.length));
  if(!pool.length){toast('No questions for selected topics','err');return;}
  var tl=0;
  if(customTimeLimit){tl=customTimeLimit;}
  else if(mode==='quiz'){tl=pool.length*45;}
  else if(mode==='exam'){tl=3600;}
  S.mcq.lastCfg={mode:mode,topics:topics,count:count,timeLimit:tl};
  S.mcq.ses={mode:mode,questions:pool,idx:0,answers:new Array(pool.length).fill(-1),revealed:new Array(pool.length).fill(false),elapsed:0,timeLimit:tl,startTime:Date.now()};
  startMcqTimer();
  var c=document.getElementById('content');c.innerHTML='';renderMcqSession(c);
}

/* ---- MCQ Session Render ---- */
/*
  Mode behaviours:
  - topic:  Click option â†’ instant reveal (correct/wrong + explanation). Next â†’ next Q.
  - exam:   Click option â†’ select only (no feedback). Next â†’ next Q. Review at end.
  - quiz:   Same as exam but timed.
*/
function revealTopicAnswer(c,ses,chosenIdx){
  var q=ses.questions[ses.idx];var letters=['A','B','C','D'];
  ses.answers[ses.idx]=chosenIdx;ses.revealed[ses.idx]=true;
  var isCorrect=chosenIdx===q.ans;
  c.querySelectorAll('.mcq-opt').forEach(function(o,i){
    o.classList.remove('sel');o.classList.add('dis');
    if(i===q.ans)o.classList.add('c-ok');
    else if(i===chosenIdx&&!isCorrect)o.classList.add('c-wrong');
  });
  /* inject explanation */
  var optsDiv=c.querySelector('.mcq-opts');
  if(optsDiv){
    var expDiv=document.createElement('div');expDiv.className='ans-sec';
    var ico=isCorrect?'fa-check-circle':'fa-times-circle';
    var col=isCorrect?'var(--ok)':'var(--no)';
    var lbl=isCorrect?'Correct!':'Incorrect â€” Answer: '+letters[q.ans];
    expDiv.innerHTML='<div style="font-weight:700;color:'+col+';margin-bottom:6px;display:flex;align-items:center;gap:6px;font-size:13px"><i class="fas '+ico+'"></i>'+lbl+'</div><div style="font-size:13px;line-height:1.6">'+esc(q.exp)+'</div>';
    optsDiv.parentNode.insertBefore(expDiv,optsDiv.nextSibling);
  }
}

function renderMcqSession(c){
  var ses=S.mcq.ses;if(!ses)return;
  var q=ses.questions[ses.idx];var letters=['A','B','C','D'];
  var isTopic=ses.mode==='topic';
  var pct=Math.round((ses.idx+1)/ses.questions.length*100);
  var h='<div class="quiz-ctr page-sec active">';
  /* progress bar */
  h+='<div class="quiz-prog"><span class="quiz-prog-tx">Q'+(ses.idx+1)+'/'+ses.questions.length+'</span><div class="quiz-prog-bar"><div class="quiz-prog-fill" style="width:'+pct+'%"></div></div></div>';
  /* timer */
  if(ses.timeLimit>0){var rem=ses.timeLimit-ses.elapsed;h+='<div class="timer-box"><div class="timer-disp'+(rem<30?' crit':rem<60?' warn':'')+'" id="mcqTimerDisp">'+fmtTime(Math.max(0,rem))+'</div></div>';}
  else{h+='<div class="timer-box"><div class="timer-disp" id="mcqTimerDisp">'+fmtTime(ses.elapsed)+'</div></div>';}
  /* mode label */
  var modeLbl=isTopic?'Topic Practice':ses.mode==='exam'?'Exam Mode':'Quiz Mode';
  var modeIc=isTopic?'fa-bullseye':ses.mode==='exam'?'fa-file-alt':'fa-clock';
  var tp=topicById(q.topic);
  h+='<div class="card" style="margin-bottom:16px"><div class="card-body">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap"><span class="badge badge-p">'+(tp?tp.name:q.topic)+'</span><span class="badge" style="background:var(--bg2);color:var(--tx2)"><i class="fas '+modeIc+'" style="margin-right:4px"></i>'+modeLbl+'</span></div>';
  h+='<p style="font-size:15px;font-weight:600;line-height:1.6;margin-bottom:16px">'+esc(q.q)+'</p>';
  h+='<div class="mcq-opts">';
  for(var i=0;i<q.opts.length;i++){
    var cls='mcq-opt';
    if(isTopic&&ses.revealed[ses.idx]){
      cls+=' dis';
      if(i===q.ans)cls+=' c-ok';
      else if(i===ses.answers[ses.idx]&&i!==q.ans)cls+=' c-wrong';
    }else if(ses.answers[ses.idx]===i){cls+=' sel';}
    h+='<div class="'+cls+'" data-oi="'+i+'"><div class="opt-let">'+letters[i]+'</div><div class="opt-tx">'+esc(q.opts[i])+'</div></div>';
  }
  h+='</div>';
  /* show explanation only for topic mode after reveal */
  if(isTopic&&ses.revealed[ses.idx]){
    var wasCorrect=ses.answers[ses.idx]===q.ans;
    var ico2=wasCorrect?'fa-check-circle':'fa-times-circle';
    var col2=wasCorrect?'var(--ok)':'var(--no)';
    var lbl2=wasCorrect?'Correct!':'Incorrect â€” Answer: '+letters[q.ans];
    h+='<div class="ans-sec"><div style="font-weight:700;color:'+col2+';margin-bottom:6px;display:flex;align-items:center;gap:6px;font-size:13px"><i class="fas '+ico2+'"></i>'+lbl2+'</div><div style="font-size:13px;line-height:1.6">'+esc(q.exp)+'</div></div>';
  }
  h+='</div></div>';
  /* action buttons */
  h+='<div class="quiz-acts">';
  h+='<button class="btn btn-s" '+(ses.idx===0?'disabled':'')+' id="mcqPrev"><i class="fas fa-arrow-left"></i> Prev</button>';
  h+='<div style="display:flex;gap:8px">';
  if(ses.idx<ses.questions.length-1){h+='<button class="btn btn-p" id="mcqNext">Next <i class="fas fa-arrow-right"></i></button>';}
  else{h+='<button class="btn btn-ok" id="mcqFinish"><i class="fas fa-flag-checkered"></i> Finish</button>';}
  h+='</div></div></div>';
  c.innerHTML=h;

  /* ---- Wire events per mode ---- */

  if(isTopic){
    /* TOPIC MODE: click option â†’ instant reveal */
    c.querySelectorAll('.mcq-opt:not(.dis)').forEach(function(el){
      el.onclick=function(){
        var idx=parseInt(el.dataset.oi,10);
        revealTopicAnswer(c,ses,idx);
      };
    });
  }else{
    /* EXAM / QUIZ MODE: click option â†’ select only, no feedback */
    c.querySelectorAll('.mcq-opt').forEach(function(el){
      el.onclick=function(){
        ses.answers[ses.idx]=parseInt(el.dataset.oi,10);
        c.querySelectorAll('.mcq-opt').forEach(function(o){o.classList.remove('sel');});
        el.classList.add('sel');
      };
    });
  }

  var prevBtn=document.getElementById('mcqPrev');
  if(prevBtn)prevBtn.onclick=function(){ses.idx--;renderMcqSession(c);};

  var nextBtn=document.getElementById('mcqNext');
  if(nextBtn)nextBtn.onclick=function(){ses.idx++;renderMcqSession(c);};

  var finBtn=document.getElementById('mcqFinish');
  if(finBtn)finBtn.onclick=function(){finishMcq();};
}

/* ---- MCQ Finish ---- */
function finishMcq(){
  if(mcqTimer)clearInterval(mcqTimer);
  var ses=S.mcq.ses;if(!ses)return;
  var correct=0;var topicCounts={};
  for(var i=0;i<ses.questions.length;i++){
    var q=ses.questions[i];var isCorrect=ses.answers[i]===q.ans;
    if(isCorrect)correct++;
    if(!topicCounts[q.topic])topicCounts[q.topic]={correct:0,attempted:0};
    topicCounts[q.topic].attempted++;
    if(isCorrect)topicCounts[q.topic].correct++;
  }
  var score=Math.round(correct/ses.questions.length*100);
  var dur=ses.elapsed;
  // Update stats
  Object.keys(topicCounts).forEach(function(tid){
    if(!S.stats.topics[tid])S.stats.topics[tid]={correct:0,attempted:0};
    S.stats.topics[tid].correct+=topicCounts[tid].correct;
    S.stats.topics[tid].attempted+=topicCounts[tid].attempted;
  });
  recordActivity('mcq',score,dur,Object.keys(topicCounts).join(','));
  S.mcq.history.push({mode:ses.mode,score:score,correct:correct,total:ses.questions.length,duration:dur,ts:Date.now(),topicCounts:topicCounts});
  renderMcqResults(document.getElementById('content'),ses,correct,score,dur);
  S.mcq.ses=null;
}

function renderMcqResults(c,ses,correct,score,dur){
  var wrong=ses.questions.length-correct;var letters=['A','B','C','D'];
  var h='<div class="quiz-ctr page-sec active">';
  h+='<div class="res-sum"><div class="res-score">'+score+'%</div><div class="res-lbl">'+correct+' of '+ses.questions.length+' correct</div>';
  h+='<div class="res-bd"><div class="bd-item"><div class="bd-val">'+correct+'</div><div class="bd-lbl">Correct</div></div><div class="bd-item"><div class="bd-val">'+wrong+'</div><div class="bd-lbl">Wrong</div></div><div class="bd-item"><div class="bd-val">'+fmtTime(dur)+'</div><div class="bd-lbl">Time</div></div></div></div>';
  h+='<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap"><button class="btn btn-p" id="newSesBtn"><i class="fas fa-redo"></i>New Session</button><button class="btn btn-s" onclick="switchView(\'practice\')"><i class="fas fa-arrow-left"></i>Back to Practice</button><button class="btn btn-s" onclick="switchView(\'dashboard\')"><i class="fas fa-home"></i>Dashboard</button>';
  if(wrong>0)h+='<button class="btn btn-s" id="retryWrong"><i class="fas fa-sync"></i>Retry Wrong ('+wrong+')</button>';
  h+='</div>';
  h+='<div class="card"><div class="card-hdr"><div class="card-t"><i class="fas fa-clipboard-list"></i>Review</div></div><div class="card-body">';
  for(var i=0;i<ses.questions.length;i++){
    var q2=ses.questions[i];var isC=ses.answers[i]===q2.ans;
    h+='<div style="padding:14px 0;border-bottom:1px solid var(--bd)">';
    h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-weight:700;font-size:13px;color:'+(isC?'var(--ok)':'var(--no)')+'"><i class="fas '+(isC?'fa-check-circle':'fa-times-circle')+'"></i> Q'+(i+1)+'</span><span class="badge badge-p" style="font-size:11px">'+(topicById(q2.topic)?topicById(q2.topic).name:q2.topic)+'</span></div>';
    h+='<p style="font-size:13px;margin-bottom:6px">'+esc(q2.q)+'</p>';
    if(!isC&&ses.answers[i]>=0)h+='<div style="font-size:12px;color:var(--no);margin-bottom:4px">Your answer: '+letters[ses.answers[i]]+'. '+esc(q2.opts[ses.answers[i]])+'</div>';
    h+='<div style="font-size:12px;color:var(--ok)">Correct: '+letters[q2.ans]+'. '+esc(q2.opts[q2.ans])+'</div>';
    h+='<div style="font-size:12px;color:var(--tx3);margin-top:4px">'+esc(q2.exp)+'</div></div>';
  }
  h+='</div></div></div>';
  c.innerHTML=h;
  /* New Session â€” restart with same config */
  var newSesBtn=document.getElementById('newSesBtn');
  if(newSesBtn)newSesBtn.onclick=function(){
    var cfg=S.mcq.lastCfg;
    if(cfg){startMcqSession(cfg.mode,cfg.topics,cfg.count,cfg.timeLimit);}
    else{switchView('practice');}
  };
  /* Retry Wrong */
  var retryBtn=document.getElementById('retryWrong');
  if(retryBtn)retryBtn.onclick=function(){
    var wrongQs=[];
    for(var j=0;j<ses.questions.length;j++){if(ses.answers[j]!==ses.questions[j].ans)wrongQs.push(ses.questions[j]);}
    if(!wrongQs.length)return;
    S.mcq.ses={mode:'topic',questions:shuffle(wrongQs),idx:0,answers:new Array(wrongQs.length).fill(-1),revealed:new Array(wrongQs.length).fill(false),elapsed:0,timeLimit:0,startTime:Date.now()};
    S.mcq.lastCfg={mode:'topic',topics:wrongQs.map(function(q){return q.topic;}),count:wrongQs.length,timeLimit:0};
    startMcqTimer();c.innerHTML='';renderMcqSession(c);
  };
}

/* ---- Long Questions Bank ---- */
var LQ_BANK=[
{id:'lq1',topic:'micro-3',title:'Demand & Supply Analysis',marks:12,difficulty:'Medium',parts:[
  {label:'(a)',text:'Explain the law of demand and illustrate with a demand curve diagram.',marks:4,hint:'Define law, draw diagram with labels, explain inverse relationship.'},
  {label:'(b)',text:'Using a supply and demand diagram, explain the effect of an increase in production costs on equilibrium price and quantity.',marks:4,hint:'Shift supply left, show new equilibrium, explain price rises & qty falls.'},
  {label:'(c)',text:'Discuss whether government intervention through a price ceiling is desirable when rents are rising.',marks:4,hint:'Define price ceiling, draw diagram showing shortage, discuss pros/cons.'}
]},
{id:'lq2',topic:'micro-5',title:'Market Failure & Externalities',marks:16,difficulty:'Hard',parts:[
  {label:'(a)',text:'Define negative externality and give one example relevant to Hong Kong.',marks:3,hint:'Social cost > private cost. Example: traffic congestion / pollution.'},
  {label:'(b)',text:'With the aid of a diagram, explain why a negative externality leads to market failure.',marks:5,hint:'Draw MSC above MPC, show overproduction at market equilibrium, deadweight loss.'},
  {label:'(c)',text:'Evaluate the effectiveness of a Pigouvian tax in correcting this market failure.',marks:4,hint:'Tax shifts MPC to MSC, discuss merits (efficient) and limitations (info problems).'},
  {label:'(d)',text:'Suggest and explain one alternative government measure to address the externality.',marks:4,hint:'Regulation / tradeable permits / subsidies for cleaner alternatives.'}
]},
{id:'lq3',topic:'macro-2',title:'National Income & Multiplier',marks:12,difficulty:'Medium',parts:[
  {label:'(a)',text:'Define the multiplier and explain how it works using the circular flow model.',marks:4,hint:'Multiplier = 1/(1-MPC). Injection â†’ successive rounds of spending.'},
  {label:'(b)',text:'If MPC is 0.75 and the government increases spending by $200 million, calculate the total increase in national income. Show your working.',marks:4,hint:'k = 1/(1-0.75) = 4. Î”Y = 4 Ã— $200m = $800m.'},
  {label:'(c)',text:'Discuss the limitations of the multiplier effect in the real world.',marks:4,hint:'Leakages (savings, taxes, imports), time lags, crowding out, inflation.'}
]},
{id:'lq4',topic:'macro-4',title:'Inflation & Unemployment',marks:16,difficulty:'Hard',parts:[
  {label:'(a)',text:'Distinguish between demand-pull inflation and cost-push inflation.',marks:4,hint:'Demand-pull: AD rises. Cost-push: AS falls. Different causes & policy responses.'},
  {label:'(b)',text:'Using an AD-AS diagram, explain the effects of demand-pull inflation on price level and real output.',marks:4,hint:'AD shifts right along upward-sloping SRAS. Price rises, output rises initially.'},
  {label:'(c)',text:'Explain the concept of stagflation and why it is difficult for the government to address.',marks:4,hint:'High inflation + high unemployment. Expansionary policy worsens inflation; contractionary worsens unemployment.'},
  {label:'(d)',text:'Evaluate one fiscal and one monetary policy measure to combat demand-pull inflation in Hong Kong.',marks:4,hint:'Fiscal: reduce G or raise taxes. Monetary: HK has limited monetary independence due to linked exchange rate.'}
]},
{id:'lq5',topic:'macro-5',title:'International Trade & HK Economy',marks:12,difficulty:'Medium',parts:[
  {label:'(a)',text:'Explain the principle of comparative advantage and how it leads to gains from trade.',marks:4,hint:'Country specialises in good with lower opportunity cost. Both gain via trade.'},
  {label:'(b)',text:'Discuss two benefits and two costs of free trade for Hong Kong.',marks:4,hint:'Benefits: efficiency, consumer choice. Costs: structural unemployment, dependence.'},
  {label:'(c)',text:'Explain how the linked exchange rate system affects Hong Kong\'s monetary policy autonomy.',marks:4,hint:'Pegged to USD â†’ cannot set independent interest rates â†’ imports US monetary conditions.'}
]},
{id:'lq6',topic:'micro-4',title:'Market Structures',marks:12,difficulty:'Medium',parts:[
  {label:'(a)',text:'Compare the characteristics of perfect competition and monopoly.',marks:4,hint:'Number of firms, product type, barriers, price-taking vs price-making.'},
  {label:'(b)',text:'Using a diagram, explain why a monopolist may earn supernormal profits in the long run.',marks:4,hint:'AR > AC at profit-maximising output (MC=MR). Barriers prevent entry.'},
  {label:'(c)',text:'Discuss whether monopoly is always harmful to society.',marks:4,hint:'Harms: higher P, lower Q, DWL. Benefits: economies of scale, innovation, natural monopoly.'}
]},
{id:'lq7',topic:'macro-3',title:'Money & Banking',marks:12,difficulty:'Medium',parts:[
  {label:'(a)',text:'Explain three functions of money.',marks:3,hint:'Medium of exchange, store of value, unit of account.'},
  {label:'(b)',text:'Explain the process of credit creation by commercial banks with a reserve ratio of 10%.',marks:5,hint:'Initial deposit â†’ loans â†’ redeposit cycle. Credit multiplier = 1/r = 10.'},
  {label:'(c)',text:'Discuss how the HKMA maintains the stability of the linked exchange rate system.',marks:4,hint:'Convertibility undertaking, buying/selling USD, adjusting aggregate balance.'}
]},
{id:'lq8',topic:'micro-2',title:'Costs & Production',marks:12,difficulty:'Medium',parts:[
  {label:'(a)',text:'Distinguish between fixed costs and variable costs, giving examples for a bakery.',marks:3,hint:'FC: rent, equipment. VC: flour, labour. FC constant, VC changes with output.'},
  {label:'(b)',text:'Draw and explain the relationship between MC, ATC, and AVC curves.',marks:5,hint:'MC cuts ATC & AVC at minimums. When MC < ATC, ATC falls; when MC > ATC, ATC rises.'},
  {label:'(c)',text:'Explain the concept of economies of scale and give two examples.',marks:4,hint:'Falling LRAC as output rises. Technical (larger machines), financial (cheaper borrowing).'}
]}
];

/* ---- Long Question Graph Tool ---- */
var GraphTool={
  canvas:null,ctx:null,mode:'pen',color:'#2563eb',lineW:2,drawing:false,paths:[],undone:[],lastPt:null,
  init:function(canvasEl){
    this.canvas=canvasEl;this.ctx=canvasEl.getContext('2d');this.paths=[];this.undone=[];this.drawing=false;this.lastPt=null;
    var dpr=window.devicePixelRatio||1;var rect=canvasEl.getBoundingClientRect();
    canvasEl.width=rect.width*dpr;canvasEl.height=rect.height*dpr;
    this.ctx.scale(dpr,dpr);this.ctx.lineCap='round';this.ctx.lineJoin='round';
    this.drawGrid();
    var self=this;
    function getPos(e){var r=canvasEl.getBoundingClientRect();var t=e.touches?e.touches[0]:e;return{x:t.clientX-r.left,y:t.clientY-r.top};}
    canvasEl.onmousedown=canvasEl.ontouchstart=function(e){e.preventDefault();self.drawing=true;self.lastPt=getPos(e);self.undone=[];self.paths.push({pts:[self.lastPt],color:self.color,width:self.lineW,mode:self.mode});};
    canvasEl.onmousemove=canvasEl.ontouchmove=function(e){if(!self.drawing)return;e.preventDefault();var p=getPos(e);var cur=self.paths[self.paths.length-1];cur.pts.push(p);self.redraw();self.lastPt=p;};
    canvasEl.onmouseup=canvasEl.ontouchend=canvasEl.onmouseleave=function(){self.drawing=false;self.lastPt=null;};
  },
  drawGrid:function(){
    var c=this.ctx;var w=this.canvas.width/(window.devicePixelRatio||1);var h2=this.canvas.height/(window.devicePixelRatio||1);
    c.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--bg1').trim()||'#fff';c.fillRect(0,0,w,h2);
    c.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--bd').trim()||'#e2e8f0';c.lineWidth=0.5;
    for(var x=0;x<=w;x+=20){c.beginPath();c.moveTo(x,0);c.lineTo(x,h2);c.stroke();}
    for(var y=0;y<=h2;y+=20){c.beginPath();c.moveTo(0,y);c.lineTo(w,y);c.stroke();}
  },
  redraw:function(){
    this.drawGrid();var c=this.ctx;
    for(var i=0;i<this.paths.length;i++){
      var p=this.paths[i];if(p.pts.length<2)continue;
      c.strokeStyle=p.mode==='eraser'?(getComputedStyle(document.documentElement).getPropertyValue('--bg1').trim()||'#fff'):p.color;
      c.lineWidth=p.mode==='eraser'?16:p.width;
      c.beginPath();c.moveTo(p.pts[0].x,p.pts[0].y);
      for(var j=1;j<p.pts.length;j++)c.lineTo(p.pts[j].x,p.pts[j].y);
      c.stroke();
    }
  },
  undo:function(){if(this.paths.length){this.undone.push(this.paths.pop());this.redraw();}},
  redo:function(){if(this.undone.length){this.paths.push(this.undone.pop());this.redraw();}},
  clear:function(){this.paths=[];this.undone=[];this.redraw();},
  toDataURL:function(){return this.canvas.toDataURL('image/png');}
};

/* ---- Long Questions Landing (HTML generator) ---- */
function renderLqLanding(){
  var h='';
  /* Sub-tabs: Bank / History */
  h+='<div class="tab-bar" id="lqTabs"><button class="tab-btn active" data-tab="bank">Question Bank</button><button class="tab-btn" data-tab="history">Past Sessions</button></div>';
  h+='<div id="lqTabBank">';
  h+='<div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center">';
  h+='<div style="flex:1;min-width:180px"><input class="form-inp" id="lqSearch" placeholder="Search questions..." style="font-size:16px"></div>';
  h+='<select class="form-sel" id="lqTopicFilter" style="width:auto;min-width:140px"><option value="">All Topics</option>';
  TOPICS.forEach(function(t){h+='<option value="'+t.id+'">'+t.name+'</option>';});
  h+='</select>';
  h+='<select class="form-sel" id="lqDiffFilter" style="width:auto;min-width:120px"><option value="">All Levels</option><option value="Medium">Medium</option><option value="Hard">Hard</option></select>';
  h+='</div>';
  h+='<div class="bank-grid" id="lqBankGrid"></div>';
  h+='</div>';
  h+='<div id="lqTabHistory" style="display:none"><div id="lqHistoryList"></div></div>';
  return h;
}

/* Wire Long Q landing events */
function wireLqLanding(c){
  var lqTabBtns=c.querySelectorAll('#lqTabs .tab-btn');
  if(!lqTabBtns.length)return;
  lqTabBtns.forEach(function(btn){
    btn.onclick=function(){
      c.querySelectorAll('#lqTabs .tab-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      var tab=btn.dataset.tab;
      document.getElementById('lqTabBank').style.display=tab==='bank'?'':'none';
      document.getElementById('lqTabHistory').style.display=tab==='history'?'':'none';
      if(tab==='history')lqRenderHistory();
    };
  });
  function lqRenderBank(){
    var searchEl=document.getElementById('lqSearch');if(!searchEl)return;
    var search=(searchEl.value||'').toLowerCase();
    var topicF=document.getElementById('lqTopicFilter').value;
    var diffF=document.getElementById('lqDiffFilter').value;
    var filtered=LQ_BANK.filter(function(q){
      if(topicF&&q.topic!==topicF)return false;
      if(diffF&&q.difficulty!==diffF)return false;
      if(search&&q.title.toLowerCase().indexOf(search)<0&&q.parts.map(function(p){return p.text;}).join(' ').toLowerCase().indexOf(search)<0)return false;
      return true;
    });
    var grid=document.getElementById('lqBankGrid');if(!grid)return;
    if(!filtered.length){grid.innerHTML='<div class="empty-state" style="grid-column:1/-1;padding:30px"><div class="empty-ic" style="font-size:32px"><i class="fas fa-search"></i></div><div class="empty-t">No questions found</div><div class="empty-tx">Try adjusting your filters</div></div>';return;}
    var gh='';
    filtered.forEach(function(q){
      var tp=topicById(q.topic);
      var dcol=q.difficulty==='Hard'?'var(--no)':'var(--wn)';
      gh+='<div class="card" style="cursor:pointer;transition:all .2s" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'var(--shl)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'var(--sh)\'" data-lqid="'+q.id+'">';
      gh+='<div class="card-body">';
      gh+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap"><span class="badge badge-p">'+(tp?tp.name:'')+'</span><span class="badge" style="background:'+dcol+'18;color:'+dcol+'">'+q.difficulty+'</span><span class="badge" style="background:var(--ac)18;color:var(--ac)">'+q.marks+' marks</span></div>';
      gh+='<div style="font-weight:700;font-size:14px;margin-bottom:8px">'+esc(q.title)+'</div>';
      gh+='<div style="font-size:12px;color:var(--tx3);margin-bottom:10px">'+q.parts.length+' parts</div>';
      gh+='<button class="btn btn-p btn-sm" style="width:100%"><i class="fas fa-play"></i>Start Practice</button>';
      gh+='</div></div>';
    });
    grid.innerHTML=gh;
    grid.querySelectorAll('[data-lqid]').forEach(function(el){
      el.querySelector('.btn').onclick=function(e){e.stopPropagation();startLongQ(el.dataset.lqid);};
      el.onclick=function(){previewLongQ(el.dataset.lqid);};
    });
  }
  lqRenderBank();
  var sEl=document.getElementById('lqSearch');if(sEl)sEl.oninput=lqRenderBank;
  var tfEl=document.getElementById('lqTopicFilter');if(tfEl)tfEl.onchange=lqRenderBank;
  var dfEl=document.getElementById('lqDiffFilter');if(dfEl)dfEl.onchange=lqRenderBank;

  function lqRenderHistory(){
    var list=document.getElementById('lqHistoryList');if(!list)return;
    if(!S.longQ.history.length){list.innerHTML='<div class="empty-state" style="padding:30px"><div class="empty-ic" style="font-size:32px"><i class="fas fa-inbox"></i></div><div class="empty-t">No sessions yet</div><div class="empty-tx">Start a long question practice!</div></div>';return;}
    var hh='';
    S.longQ.history.slice().reverse().forEach(function(s5){
      hh+='<div class="card" style="margin-bottom:10px"><div class="card-body" style="padding:14px 18px;display:flex;align-items:center;gap:14px">';
      hh+='<div style="width:38px;height:38px;border-radius:50%;background:var(--ac)18;display:flex;align-items:center;justify-content:center"><i class="fas fa-pen-fancy" style="color:var(--ac);font-size:14px"></i></div>';
      hh+='<div style="flex:1"><div style="font-weight:600;font-size:14px">'+esc(s5.title)+'</div><div style="font-size:12px;color:var(--tx3)">'+fmtDate(s5.ts)+' &bull; '+fmtTime(s5.duration)+' &bull; '+s5.partsCompleted+'/'+s5.partsTotal+' parts</div></div>';
      if(s5.feedbackReceived)hh+='<span class="badge badge-ok"><i class="fas fa-check"></i>Feedback</span>';
      hh+='</div></div>';
    });
    list.innerHTML=hh;
  }
}

/* ---- Long Question Preview ---- */
function previewLongQ(qId){
  var q=null;for(var i=0;i<LQ_BANK.length;i++){if(LQ_BANK[i].id===qId){q=LQ_BANK[i];break;}}
  if(!q)return;var tp=topicById(q.topic);
  var h='<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px"><h3 style="font-weight:700;flex:1">'+esc(q.title)+'</h3><button class="btn btn-ghost" onclick="Modal.hide()"><i class="fas fa-times"></i></button></div>';
  h+='<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap"><span class="badge badge-p">'+(tp?tp.name:'')+'</span><span class="badge badge-w">'+q.difficulty+'</span><span class="badge" style="background:var(--ac)18;color:var(--ac)">'+q.marks+' marks</span></div>';
  q.parts.forEach(function(p){
    h+='<div style="padding:12px 0;border-bottom:1px solid var(--bd)"><div style="display:flex;gap:8px;align-items:baseline"><span style="font-weight:700;color:var(--pr)">'+p.label+'</span><span style="font-size:14px;line-height:1.6">'+esc(p.text)+'</span></div><div style="font-size:12px;color:var(--tx3);margin-top:4px">'+p.marks+' marks</div></div>';
  });
  h+='<div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px"><button class="btn btn-s" onclick="Modal.hide()">Close</button><button class="btn btn-p" onclick="Modal.hide();startLongQ(\''+q.id+'\')"><i class="fas fa-play"></i>Start Practice</button></div>';
  Modal.show(h);
}

/* ---- Start Long Q Session ---- */
function startLongQ(qId){
  var q=null;for(var i=0;i<LQ_BANK.length;i++){if(LQ_BANK[i].id===qId){q=LQ_BANK[i];break;}}
  if(!q)return;
  S.longQ.ses={
    question:q,partIdx:0,startTime:Date.now(),elapsed:0,
    answers:q.parts.map(function(){return '';}),
    graphs:q.parts.map(function(){return null;}),
    feedback:null,submitted:false
  };
  lqTimer=setInterval(function(){
    if(!S.longQ.ses)return;S.longQ.ses.elapsed++;
    var el=document.getElementById('lqTimerDisp');if(el)el.textContent=fmtTime(S.longQ.ses.elapsed);
  },1000);
  var c=document.getElementById('content');c.innerHTML='';renderLongQSession(c);
}
var lqTimer=null;

/* ---- Render Long Q Session ---- */
function renderLongQSession(c){
  var ses=S.longQ.ses;if(!ses)return;
  var q=ses.question;var pidx=ses.partIdx;var part=q.parts[pidx];var tp=topicById(q.topic);
  var pct=Math.round((pidx+1)/q.parts.length*100);

  var h='<div class="quiz-ctr page-sec active">';
  /* Progress */
  h+='<div class="quiz-prog"><span class="quiz-prog-tx">Part '+(pidx+1)+'/'+q.parts.length+'</span><div class="quiz-prog-bar"><div class="quiz-prog-fill" style="width:'+pct+'%"></div></div><span class="quiz-prog-tx" id="lqTimerDisp">'+fmtTime(ses.elapsed)+'</span></div>';

  /* Question header */
  h+='<div class="card" style="margin-bottom:16px"><div class="card-body">';
  h+='<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap"><span class="badge badge-p">'+(tp?tp.name:'')+'</span><span style="font-weight:700;font-size:15px">'+esc(q.title)+'</span></div>';
  h+='<div style="display:flex;gap:8px;align-items:baseline;margin-bottom:8px"><span style="font-weight:800;color:var(--pr);font-size:16px">'+part.label+'</span><span style="font-size:15px;line-height:1.6">'+esc(part.text)+'</span></div>';
  h+='<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><span class="badge" style="background:var(--ac)18;color:var(--ac)">'+part.marks+' marks</span>';
  h+='<button class="btn btn-ghost btn-sm" id="lqHintBtn"><i class="fas fa-lightbulb" style="color:var(--wn)"></i>Show Hint</button>';
  h+='</div>';
  h+='<div id="lqHintBox" style="display:none;margin-top:10px;padding:12px;background:rgba(245,158,11,.08);border-radius:8px;border-left:3px solid var(--wn);font-size:13px;color:var(--tx2)"></div>';
  h+='</div></div>';

  /* Tabbed answer/diagram area */
  var activeAnsTab=ses._activeTab||'write';
  h+='<div class="card" style="margin-bottom:0">';
  h+='<div class="tab-bar" id="lqAnsTabs" style="padding:0 16px;border-bottom:1px solid var(--bd)">';
  h+='<button class="tab-btn '+(activeAnsTab==='write'?'active':'')+'" data-anstab="write"><i class="fas fa-edit" style="margin-right:6px"></i>Written Answer</button>';
  h+='<button class="tab-btn '+(activeAnsTab==='diagram'?'active':'')+'" data-anstab="diagram"><i class="fas fa-chart-area" style="margin-right:6px"></i>Diagram</button>';
  h+='</div>';

  /* Written answer pane */
  h+='<div id="lqWritePane" style="display:'+(activeAnsTab==='write'?'block':'none')+'">';
  h+='<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px 0"><div style="font-size:12px;color:var(--tx3)" id="lqWordCount">0 words</div></div>';
  h+='<div class="rich-bar" id="lqRichBar">';
  [{ic:'fa-bold',cmd:'bold'},{ic:'fa-italic',cmd:'italic'},{ic:'fa-underline',cmd:'underline'},{ic:'fa-list-ul',cmd:'insertUnorderedList'},{ic:'fa-list-ol',cmd:'insertOrderedList'},{ic:'fa-subscript',cmd:'subscript'},{ic:'fa-superscript',cmd:'superscript'}].forEach(function(b){
    h+='<button data-cmd="'+b.cmd+'" title="'+b.cmd+'"><i class="fas '+b.ic+'"></i></button>';
  });
  h+='</div>';
  h+='<div contenteditable="true" class="form-inp rich-ta" id="lqEditor" style="min-height:320px;max-height:500px;overflow-y:auto;line-height:1.7;font-size:15px;white-space:pre-wrap;margin:0 16px 16px;border-radius:8px">'+ses.answers[pidx]+'</div>';
  h+='</div>';

  /* Diagram pane */
  h+='<div id="lqDiagramPane" style="display:'+(activeAnsTab==='diagram'?'block':'none')+';padding:16px">';
  h+='<canvas id="lqCanvas" style="width:100%;height:360px;border-radius:8px;border:1px solid var(--bd)"></canvas>';
  h+='<div class="graph-tools" style="margin-top:10px">';
  h+='<button class="lqg-btn" data-tool="pen" style="background:rgba(37,99,235,.1);color:var(--pr);border-color:var(--pr)"><i class="fas fa-pen"></i> Pen</button>';
  h+='<button class="lqg-btn" data-tool="eraser"><i class="fas fa-eraser"></i> Eraser</button>';
  h+='<button class="lqg-btn" data-tool="text"><i class="fas fa-font"></i> Label</button>';
  h+='<input type="color" value="#2563eb" id="lqGraphColor" style="width:32px;height:28px;border:none;cursor:pointer;border-radius:4px">';
  h+='<select id="lqGraphWidth" style="padding:4px 8px;border:1px solid var(--bd);border-radius:6px;font-size:12px;background:var(--bg1);color:var(--tx1)"><option value="2">Thin</option><option value="4">Medium</option><option value="6">Thick</option></select>';
  h+='<span style="flex:1"></span>';
  h+='<button class="lqg-btn" data-tool="undo"><i class="fas fa-undo"></i></button>';
  h+='<button class="lqg-btn" data-tool="redo"><i class="fas fa-redo"></i></button>';
  h+='<button class="lqg-btn" data-tool="clear"><i class="fas fa-trash"></i></button>';
  h+='</div>';
  h+='</div>';

  h+='</div>'; /* end card */

  /* Navigation */
  h+='<div class="quiz-acts" style="margin-top:16px">';
  h+='<button class="btn btn-s" '+(pidx===0?'disabled':'')+' id="lqPrev"><i class="fas fa-arrow-left"></i>Previous</button>';
  h+='<div style="display:flex;gap:8px">';
  if(pidx<q.parts.length-1){h+='<button class="btn btn-p" id="lqNext">Next Part<i class="fas fa-arrow-right"></i></button>';}
  else{h+='<button class="btn btn-ok" id="lqSubmit"><i class="fas fa-paper-plane"></i>Submit for Feedback</button>';}
  h+='</div></div>';

  /* Feedback area */
  if(ses.feedback){
    h+='<div class="card" style="margin-top:16px"><div class="card-hdr"><div class="card-t"><i class="fas fa-robot"></i>AI Feedback</div></div><div class="card-body md-content" id="lqFeedbackContent">'+renderMd(ses.feedback)+'</div></div>';
  }
  h+='</div>';
  c.innerHTML=h;

  /* Wire answer/diagram tab switching */
  var graphInited=activeAnsTab==='diagram';
  c.querySelectorAll('#lqAnsTabs .tab-btn').forEach(function(btn){
    btn.onclick=function(){
      c.querySelectorAll('#lqAnsTabs .tab-btn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      var tab=btn.dataset.anstab;
      ses._activeTab=tab;
      document.getElementById('lqWritePane').style.display=tab==='write'?'block':'none';
      document.getElementById('lqDiagramPane').style.display=tab==='diagram'?'block':'none';
      if(tab==='diagram'&&!graphInited){
        graphInited=true;
        var cv=document.getElementById('lqCanvas');
        GraphTool.init(cv);
        if(ses.graphs[pidx]){
          var im=new Image();im.onload=function(){GraphTool.drawGrid();GraphTool.ctx.drawImage(im,0,0,cv.width/(window.devicePixelRatio||1),cv.height/(window.devicePixelRatio||1));};im.src=ses.graphs[pidx];
        }
      }
    };
  });

  /* Wire editor */
  var editor=document.getElementById('lqEditor');
  var wcEl=document.getElementById('lqWordCount');
  function updateWC(){var txt=(editor.innerText||'').trim();var words=txt?txt.split(/\s+/).length:0;wcEl.textContent=words+' words';ses.answers[pidx]=editor.innerHTML;}
  editor.oninput=updateWC;
  updateWC();

  /* Rich bar commands */
  document.querySelectorAll('#lqRichBar button').forEach(function(btn){
    btn.onclick=function(e){e.preventDefault();document.execCommand(btn.dataset.cmd,false,null);editor.focus();};
  });

  /* Hint toggle */
  document.getElementById('lqHintBtn').onclick=function(){
    var box=document.getElementById('lqHintBox');
    if(box.style.display==='none'){box.style.display='block';box.textContent=part.hint;this.innerHTML='<i class="fas fa-lightbulb" style="color:var(--wn)"></i>Hide Hint';}
    else{box.style.display='none';this.innerHTML='<i class="fas fa-lightbulb" style="color:var(--wn)"></i>Show Hint';}
  };

  /* Init graph only if diagram tab is already active */
  var canvas=document.getElementById('lqCanvas');
  if(activeAnsTab==='diagram'){
    graphInited=true;
    GraphTool.init(canvas);
    if(ses.graphs[pidx]){
      var img=new Image();img.onload=function(){
        GraphTool.drawGrid();
        GraphTool.ctx.drawImage(img,0,0,canvas.width/(window.devicePixelRatio||1),canvas.height/(window.devicePixelRatio||1));
      };img.src=ses.graphs[pidx];
    }
  }

  /* Graph tool buttons */
  document.querySelectorAll('.lqg-btn').forEach(function(btn){
    btn.onclick=function(){
      var tool=btn.dataset.tool;
      if(tool==='undo'){GraphTool.undo();return;}
      if(tool==='redo'){GraphTool.redo();return;}
      if(tool==='clear'){GraphTool.clear();return;}
      if(tool==='text'){
        var label=null;
        /* Simple text label modal */
        var mh='<h3 style="font-weight:700;margin-bottom:12px">Add Label</h3>';
        mh+='<input class="form-inp" id="graphLabelInp" placeholder="Enter text (e.g. P1, S1, D)" style="margin-bottom:14px">';
        mh+='<div style="display:flex;gap:10px;justify-content:flex-end"><button class="btn btn-s" onclick="Modal.hide()">Cancel</button><button class="btn btn-p" id="graphLabelOk">Add</button></div>';
        Modal.show(mh);
        document.getElementById('graphLabelInp').focus();
        document.getElementById('graphLabelOk').onclick=function(){
          label=document.getElementById('graphLabelInp').value;Modal.hide();
          if(label){
            var cFont='bold 14px Plus Jakarta Sans, sans-serif';GraphTool.ctx.font=cFont;GraphTool.ctx.fillStyle=GraphTool.color;
            /* Place in center - user can use pen to mark where */
            var cw2=canvas.width/(window.devicePixelRatio||1);var ch2=canvas.height/(window.devicePixelRatio||1);
            GraphTool.ctx.fillText(label,cw2/2,ch2/2);
            GraphTool.paths.push({pts:[{x:cw2/2,y:ch2/2}],color:GraphTool.color,width:1,mode:'text',label:label});
          }
        };
        return;
      }
      GraphTool.mode=tool;
      document.querySelectorAll('.lqg-btn').forEach(function(b){b.style.background='';b.style.color='';b.style.borderColor='';});
      btn.style.background='rgba(37,99,235,.1)';btn.style.color='var(--pr)';btn.style.borderColor='var(--pr)';
    };
  });
  document.getElementById('lqGraphColor').onchange=function(){GraphTool.color=this.value;};
  document.getElementById('lqGraphWidth').onchange=function(){GraphTool.lineW=parseInt(this.value,10);};

  /* Navigation */
  function saveCurrent(){ses.answers[pidx]=editor.innerHTML;if(graphInited)ses.graphs[pidx]=GraphTool.toDataURL();}
  var prevBtn=document.getElementById('lqPrev');if(prevBtn)prevBtn.onclick=function(){saveCurrent();ses.partIdx--;renderLongQSession(c);};
  var nextBtn=document.getElementById('lqNext');if(nextBtn)nextBtn.onclick=function(){saveCurrent();ses.partIdx++;renderLongQSession(c);};
  var subBtn=document.getElementById('lqSubmit');if(subBtn)subBtn.onclick=function(){saveCurrent();submitLongQ(c);};
}

/* ---- Submit Long Q for AI Feedback ---- */
function submitLongQ(c){
  var ses=S.longQ.ses;if(!ses)return;
  if(lqTimer)clearInterval(lqTimer);

  /* Check if any answers are empty */
  var emptyParts=[];
  for(var i=0;i<ses.question.parts.length;i++){
    var txt=(ses.answers[i]||'').replace(/<[^>]*>/g,'').trim();
    if(!txt)emptyParts.push(ses.question.parts[i].label);
  }
  if(emptyParts.length===ses.question.parts.length){
    toast('Please write at least one answer before submitting','err');
    lqTimer=setInterval(function(){if(!S.longQ.ses)return;S.longQ.ses.elapsed++;var el=document.getElementById('lqTimerDisp');if(el)el.textContent=fmtTime(S.longQ.ses.elapsed);},1000);
    return;
  }

  /* Build prompt for AI feedback */
  var prompt='You are an expert HKDSE Economics teacher. Grade and give detailed feedback on this student\'s answer.\n\n';
  prompt+='**Question: '+ses.question.title+'** ('+ses.question.marks+' marks total)\n\n';
  ses.question.parts.forEach(function(p,idx){
    var ans=(ses.answers[idx]||'').replace(/<[^>]*>/g,'').trim();
    prompt+=p.label+' '+p.text+' ['+p.marks+' marks]\n';
    prompt+='**Student\'s answer:** '+(ans||'(No answer provided)')+'\n\n';
  });
  prompt+='\nFor each part:\n1. Award marks out of the maximum\n2. State what was done well\n3. State what was missing or incorrect\n4. Provide a model answer\n\nEnd with overall marks, percentage, and key areas for improvement.\nFormat using Markdown.';

  ses.submitted=true;

  /* Show loading */
  document.getElementById('loadOv').style.display='flex';
  document.getElementById('loadTx').textContent='Getting AI Feedback...';
  document.getElementById('loadSub').textContent='Analyzing your answers';

  /* Register handler */
  window.Poe.registerHandler('lq-feedback-handler',function(result){
    var msg=result.responses[0];
    if(msg.status==='error'){
      document.getElementById('loadOv').style.display='none';
      toast('Error getting feedback: '+(msg.statusText||'Unknown error'),'err');
      return;
    }
    if(msg.status==='incomplete'){
      /* Show partial feedback while streaming */
      document.getElementById('loadSub').textContent='Receiving feedback...';
      ses.feedback=msg.content;
      var fbEl=document.getElementById('lqFeedbackContent');
      if(fbEl)fbEl.innerHTML=renderMd(msg.content);
    }
    if(msg.status==='complete'){
      document.getElementById('loadOv').style.display='none';
      ses.feedback=msg.content;
      /* Record history */
      var completed=0;
      for(var j=0;j<ses.question.parts.length;j++){if((ses.answers[j]||'').replace(/<[^>]*>/g,'').trim())completed++;}
      S.longQ.history.push({
        title:ses.question.title,qId:ses.question.id,ts:Date.now(),
        duration:ses.elapsed,partsCompleted:completed,partsTotal:ses.question.parts.length,
        feedbackReceived:true,feedback:ses.feedback
      });
      recordActivity('long-q',0,ses.elapsed,ses.question.topic);
      renderLongQSession(c);
      toast('Feedback received!','ok');
    }
  });

  /* Send to AI */
  window.Poe.sendUserMessage('@Claude-Sonnet-4.5 '+prompt,{
    handler:'lq-feedback-handler',stream:true,openChat:false,parameters:{}
  }).then(function(){
    /* Show feedback area */
    ses.feedback='Waiting for AI response...';
    renderLongQSession(c);
  }).catch(function(err){
    document.getElementById('loadOv').style.display='none';
    toast('Failed to send: '+err,'err');
  });
}

/* ---- AI Generation (placeholder) ---- */
Sections['ai-gen']=function(c){
  c.innerHTML='<div class="page-sec active"><div style="text-align:center;margin-bottom:28px"><h2 style="font-size:1.5rem;font-weight:800"><i class="fas fa-robot" style="color:var(--ok);margin-right:8px"></i>AI Generation</h2><p style="color:var(--tx2);margin-top:4px">Generate custom questions with AI</p></div><div class="empty-state"><div class="empty-ic"><i class="fas fa-robot"></i></div><div class="empty-t">AI Generation Module</div><div class="empty-tx">AI-powered question generation and tutoring coming in next update.</div></div></div>';
};

/* ---- Analytics ---- */
var anCharts={};
Sections.analytics=function(c){
  var st=S.stats;var tq=0,tc=0;
  Object.keys(st.topics).forEach(function(k){tq+=st.topics[k].attempted;tc+=st.topics[k].correct;});
  var acc=tq>0?Math.round(tc/tq*100):0;
  var allHist=S.mcq.history.concat(S.longQ.history||[]).sort(function(a,b){return(b.ts||0)-(a.ts||0);});
  var streak=0;if(allHist.length){var d=new Date();d.setHours(0,0,0,0);var check=true;while(check){var dt=d.getTime();var found=allHist.some(function(h2){var hd=new Date(h2.ts);hd.setHours(0,0,0,0);return hd.getTime()===dt;});if(found){streak++;d.setDate(d.getDate()-1);}else{check=false;}}}
  var h='<div class="page-sec active">';
  h+='<div style="text-align:center;margin-bottom:22px"><h2 style="font-size:1.5rem;font-weight:800"><i class="fas fa-chart-pie" style="color:var(--pr);margin-right:8px"></i>Analytics</h2><p style="color:var(--tx2);margin-top:4px;font-size:14px">Track your study progress and performance</p></div>';
  /* tabs */
  h+='<div class="an-tabs"><button class="an-tab active" data-an="overview">Overview</button><button class="an-tab" data-an="topics">Topics</button><button class="an-tab" data-an="history">History</button><button class="an-tab" data-an="insights">Insights</button></div>';
  /* OVERVIEW pane */
  h+='<div class="an-pane active" id="anOverview">';
  h+='<div class="an-kpi-row">';
  h+='<div class="an-kpi"><div class="an-kpi-val">'+st.sessions+'</div><div class="an-kpi-lbl"><i class="fas fa-book-open"></i> Sessions</div></div>';
  h+='<div class="an-kpi"><div class="an-kpi-val">'+tq+'</div><div class="an-kpi-lbl"><i class="fas fa-list-ol"></i> Questions</div></div>';
  h+='<div class="an-kpi"><div class="an-kpi-val">'+acc+'%</div><div class="an-kpi-lbl"><i class="fas fa-bullseye"></i> Accuracy</div></div>';
  h+='<div class="an-kpi"><div class="an-kpi-val">'+streak+'</div><div class="an-kpi-lbl"><i class="fas fa-fire"></i> Day Streak</div></div>';
  h+='</div>';
  /* Score Trend chart */
  h+='<div class="an-chart-wrap"><div class="an-chart-title"><i class="fas fa-chart-line"></i>Score Trend</div><div class="an-canvas-box" style="height:220px"><canvas id="anTrendChart"></canvas></div></div>';
  /* Study Activity heatmap */
  h+='<div class="an-chart-wrap"><div class="an-chart-title"><i class="fas fa-fire"></i>Study Activity (Last 28 Days)</div><div style="display:flex;gap:4px;margin-bottom:6px;font-size:10px;color:var(--tx3)"><span style="flex:1">Mon</span><span style="flex:1">Tue</span><span style="flex:1">Wed</span><span style="flex:1">Thu</span><span style="flex:1">Fri</span><span style="flex:1">Sat</span><span style="flex:1">Sun</span></div><div class="an-streak-grid" id="anStreak"></div><div style="display:flex;align-items:center;gap:6px;justify-content:flex-end;font-size:11px;color:var(--tx3)">Less <div class="an-streak-day" style="width:14px;height:14px;display:inline-block"></div><div class="an-streak-day l1" style="width:14px;height:14px;display:inline-block"></div><div class="an-streak-day l2" style="width:14px;height:14px;display:inline-block"></div><div class="an-streak-day l3" style="width:14px;height:14px;display:inline-block"></div><div class="an-streak-day l4" style="width:14px;height:14px;display:inline-block"></div> More</div></div>';
  /* Time studied */
  h+='<div class="an-chart-wrap"><div class="an-chart-title"><i class="fas fa-clock"></i>Total Study Time</div><div style="text-align:center;padding:16px"><span style="font-size:38px;font-weight:800">'+fmtTime(st.time)+'</span><div style="font-size:13px;color:var(--tx3);margin-top:4px">minutes:seconds</div></div></div>';
  h+='</div>';
  /* TOPICS pane */
  h+='<div class="an-pane" id="anTopics">';
  h+='<div class="an-chart-wrap"><div class="an-chart-title"><i class="fas fa-spider"></i>Topic Radar</div><div class="an-canvas-box" style="height:280px"><canvas id="anRadarChart"></canvas></div></div>';
  h+='<div class="topic-stat-grid">';
  TOPICS.forEach(function(t){
    var ts=st.topics[t.id];var pct=0,att=0,cor=0;
    if(ts){att=ts.attempted;cor=ts.correct;pct=att>0?Math.round(cor/att*100):0;}
    var col=pct>=70?'var(--ok)':pct>=50?'var(--wn)':att>0?'var(--no)':'var(--tx3)';
    h+='<div class="topic-stat-card"><div class="ts-hdr"><div class="ts-ic" style="background:'+col+'18;color:'+col+'"><i class="fas '+t.icon+'"></i></div><div class="ts-name">'+t.name+'</div><div class="ts-acc" style="color:'+col+'">'+(att>0?pct+'%':'â€”')+'</div></div>';
    h+='<div style="height:6px;background:var(--bd);border-radius:3px;overflow:hidden"><div style="height:100%;width:'+pct+'%;background:'+col+';border-radius:3px;transition:width .3s"></div></div>';
    h+='<div style="font-size:11px;color:var(--tx3);margin-top:6px">'+att+' attempted &bull; '+cor+' correct</div></div>';
  });
  h+='</div></div>';
  /* HISTORY pane */
  h+='<div class="an-pane" id="anHistory">';
  if(!allHist.length)h+='<div class="empty-state"><div class="empty-ic"><i class="fas fa-clock"></i></div><div class="empty-t">No Sessions Yet</div><div class="empty-tx">Complete practice sessions to see your history here.</div></div>';
  else{
    allHist.forEach(function(s4){
      var co=s4.score>=70?'var(--ok)':s4.score>=50?'var(--wn)':'var(--no)';
      var isLq=!!s4.qTitle;
      h+='<div class="an-hist-item"><div class="an-hist-badge" style="background:'+co+'18;color:'+co+'">'+s4.score+'<small>%</small></div><div class="an-hist-info"><div class="an-hist-title">'+(isLq?'Long Q: '+(s4.qTitle||'Question'):(s4.mode||'Practice')+' &bull; '+s4.correct+'/'+s4.total)+'</div><div class="an-hist-meta"><span><i class="fas fa-calendar"></i> '+fmtDate(s4.ts)+'</span><span><i class="fas fa-clock"></i> '+fmtTime(s4.duration||0)+'</span>'+(s4.topics?'<span><i class="fas fa-tag"></i> '+s4.topics+'</span>':'')+'</div></div></div>';
    });
  }
  h+='</div>';
  /* INSIGHTS pane */
  h+='<div class="an-pane" id="anInsights">';
  var weakTopics=[];var strongTopics=[];
  TOPICS.forEach(function(t){var ts=st.topics[t.id];if(ts&&ts.attempted>0){var p=Math.round(ts.correct/ts.attempted*100);if(p<60)weakTopics.push({name:t.name,pct:p,att:ts.attempted});else if(p>=80)strongTopics.push({name:t.name,pct:p,att:ts.attempted});}});
  if(tq===0){
    h+='<div class="empty-state"><div class="empty-ic"><i class="fas fa-brain"></i></div><div class="empty-t">No Data Yet</div><div class="empty-tx">Complete some practice sessions to unlock AI-powered study insights.</div></div>';
  }else{
    h+='<div class="an-chart-wrap"><div class="an-chart-title"><i class="fas fa-chart-doughnut"></i>Score Distribution</div><div class="an-canvas-box" style="height:220px"><canvas id="anDoughnut"></canvas></div></div>';
    if(weakTopics.length){h+='<div class="an-ins-card" style="border-left-color:var(--no)"><h4><i class="fas fa-exclamation-triangle" style="color:var(--no)"></i>Focus Areas</h4><p>You scored below 60% in: <strong>'+weakTopics.map(function(w){return w.name+' ('+w.pct+'%)';}).join(', ')+'</strong>. Consider reviewing these topics and practising more questions.</p></div>';}
    if(strongTopics.length){h+='<div class="an-ins-card" style="border-left-color:var(--ok)"><h4><i class="fas fa-trophy" style="color:var(--ok)"></i>Strong Topics</h4><p>Excellent performance in: <strong>'+strongTopics.map(function(s5){return s5.name+' ('+s5.pct+'%)';}).join(', ')+'</strong>. Keep up the great work!</p></div>';}
    h+='<div class="an-ins-card"><h4><i class="fas fa-lightbulb" style="color:var(--wn)"></i>Study Tips</h4><p>You\'ve completed <strong>'+st.sessions+'</strong> sessions with an overall accuracy of <strong>'+acc+'%</strong>.'+(acc<70?' Try to review incorrect answers after each session and focus on understanding the reasoning behind correct answers.':' Great accuracy! Challenge yourself with harder questions and try timed exam mode.')+'</p></div>';
  }
  h+='</div>';
  h+='</div>';
  c.innerHTML=h;
  /* Wire tabs */
  c.querySelectorAll('.an-tab').forEach(function(tb){tb.onclick=function(){
    c.querySelectorAll('.an-tab').forEach(function(b){b.classList.remove('active');});
    c.querySelectorAll('.an-pane').forEach(function(p){p.classList.remove('active');});
    tb.classList.add('active');
    var paneId='an'+tb.getAttribute('data-an').charAt(0).toUpperCase()+tb.getAttribute('data-an').slice(1);
    var pane=document.getElementById(paneId);if(pane)pane.classList.add('active');
    if(tb.getAttribute('data-an')==='topics')renderRadar();
    if(tb.getAttribute('data-an')==='insights')renderDoughnut();
  };});
  /* Render streak heatmap */
  (function(){
    var grid=document.getElementById('anStreak');if(!grid)return;
    var today=new Date();today.setHours(0,0,0,0);
    var dayOfWeek=today.getDay();var startOffset=((dayOfWeek+6)%7)+27;
    var startDate=new Date(today);startDate.setDate(startDate.getDate()-startOffset);
    for(var i=0;i<28;i++){
      var dd=new Date(startDate);dd.setDate(dd.getDate()+i);dd.setHours(0,0,0,0);
      var cnt=0;allHist.forEach(function(h2){var hd=new Date(h2.ts);hd.setHours(0,0,0,0);if(hd.getTime()===dd.getTime())cnt++;});
      var lvl=cnt===0?'':cnt<=1?'l1':cnt<=2?'l2':cnt<=4?'l3':'l4';
      var cell=document.createElement('div');cell.className='an-streak-day '+lvl;
      cell.title=dd.toLocaleDateString('en-HK',{day:'numeric',month:'short'})+': '+cnt+' session'+(cnt!==1?'s':'');
      grid.appendChild(cell);
    }
  })();
  /* Render trend chart */
  renderTrend();
  function renderTrend(){
    var cv=document.getElementById('anTrendChart');if(!cv)return;
    if(anCharts.trend){anCharts.trend.destroy();}
    var mcqH=S.mcq.history.slice(-15);
    var labels=mcqH.map(function(h2,i){return fmtDate(h2.ts)||'#'+(i+1);});
    var scores=mcqH.map(function(h2){return h2.score;});
    if(!labels.length){labels=['No data'];scores=[0];}
    var isDark=document.documentElement.classList.contains('dark');
    var gridC=isDark?'rgba(255,255,255,.08)':'rgba(0,0,0,.06)';
    var txC=isDark?'#94a3b8':'#64748b';
    anCharts.trend=new Chart(cv,{type:'line',data:{labels:labels,datasets:[{label:'Score %',data:scores,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.12)',fill:true,tension:.4,pointRadius:4,pointBackgroundColor:'#3b82f6',pointBorderColor:'#fff',pointBorderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:0,max:100,grid:{color:gridC},ticks:{color:txC,font:{size:11}}},x:{grid:{display:false},ticks:{color:txC,font:{size:11},maxRotation:45}}}}});
  }
  function renderRadar(){
    var cv=document.getElementById('anRadarChart');if(!cv)return;
    if(anCharts.radar){anCharts.radar.destroy();}
    var labels=TOPICS.map(function(t){return t.name.length>18?t.name.substring(0,16)+'â€¦':t.name;});
    var data=TOPICS.map(function(t){var ts=st.topics[t.id];return ts&&ts.attempted>0?Math.round(ts.correct/ts.attempted*100):0;});
    var isDark=document.documentElement.classList.contains('dark');
    var gridC=isDark?'rgba(255,255,255,.1)':'rgba(0,0,0,.08)';
    var txC=isDark?'#94a3b8':'#64748b';
    anCharts.radar=new Chart(cv,{type:'radar',data:{labels:labels,datasets:[{label:'Accuracy %',data:data,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.18)',pointBackgroundColor:'#3b82f6',pointRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{r:{min:0,max:100,ticks:{display:false,stepSize:20},grid:{color:gridC},pointLabels:{color:txC,font:{size:10}}}}}});
  }
  function renderDoughnut(){
    var cv=document.getElementById('anDoughnut');if(!cv)return;
    if(anCharts.doughnut){anCharts.doughnut.destroy();}
    var good=0,mid=0,bad=0;
    S.mcq.history.forEach(function(h2){if(h2.score>=70)good++;else if(h2.score>=50)mid++;else bad++;});
    anCharts.doughnut=new Chart(cv,{type:'doughnut',data:{labels:['â‰¥70% (Good)','50-69% (Fair)','<50% (Needs Work)'],datasets:[{data:[good,mid,bad],backgroundColor:['#10b981','#f59e0b','#ef4444'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'bottom',labels:{padding:12,font:{size:12}}}}}});
  }
};

/* ---- App Init ---- */
(function(){
  initNav();
  switchView('dashboard');
})();
</script>
</body>
</html>